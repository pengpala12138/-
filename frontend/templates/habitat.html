<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ –æ¯åœ°åˆ†æ - ç”Ÿç‰©å¤šæ ·æ€§ç›‘æµ‹ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        /* ========== å…¨å±€å˜é‡ï¼ˆåŒæ­¥åŒ—æ—é…è‰²ï¼‰ ========== */
        :root {
            --bjfu-primary: #0A5E38;        /* åŒ—æ—æ·±ç»¿ - ä¸»è‰²è°ƒ */
            --bjfu-secondary: #147D4C;      /* åŒ—æ—hoverç»¿ - è¾…åŠ©è‰² */
            --bjfu-light: #E6F4EA;          /* æµ…ç»¿èƒŒæ™¯ */
            --bjfu-accent: #FFC107;         /* é‡‘è‰²ç‚¹ç¼€ */
            --bjfu-dark: #0A5E38;           /* æ·±ç»¿ï¼ˆä¸ä¸»è‰²è°ƒä¸€è‡´ï¼‰ */
            --bjfu-text: #333333;           /* ä¸»è¦æ–‡å­—è‰² */
            --bjfu-text-light: #666666;     /* æ¬¡è¦æ–‡å­—è‰² */
            --bjfu-border: #B3E0C2;         /* è¾¹æ¡†è‰²ï¼ˆåŸºäºæµ…ç»¿è°ƒæ•´ï¼‰ */
            --bjfu-shadow: rgba(10, 94, 56, 0.1); /* é˜´å½±ï¼ˆåŸºäºä¸»è‰²è°ƒï¼‰ */
            --bjfu-gradient: linear-gradient(135deg, #0A5E38 0%, #147D4C 100%); /* æ¸å˜ï¼ˆä¸»è‰²åˆ°hoverè‰²ï¼‰ */
        }

        /* ========== å…¨å±€æ ·å¼é‡ç½® ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans SC', 'Microsoft YaHei', 'Segoe UI', sans-serif;
            background-color: #F5F7F6; /* åŒ—æ—æµ…ç°èƒŒæ™¯ */
            color: var(--bjfu-text);
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }

        /* ========== å¯¼èˆªæ æ ·å¼ ========== */
        .navbar {
            background: var(--bjfu-gradient) !important;
            box-shadow: 0 4px 12px var(--bjfu-shadow);
            padding: 0.8rem 0;
            border-bottom: 3px solid var(--bjfu-accent);
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1030;
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            background: linear-gradient(to right, #FFFFFF 0%, #FFD700 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            padding-left: 45px;
        }

        .navbar-brand::before {
            content: "ğŸŒ³";
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.8rem;
        }

        .navbar-nav .nav-link {
            color: rgba(255, 255, 255, 0.9) !important;
            font-weight: 500;
            padding: 0.5rem 1.2rem;
            margin: 0 0.2rem;
            border-radius: 4px;
            transition: all 0.3s ease;
            position: relative;
        }

        .navbar-nav .nav-link:hover {
            color: white !important;
            background-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .navbar-nav .nav-link.active {
            background-color: rgba(255, 255, 255, 0.25);
            color: white !important;
        }

        /* ========== ä¾§è¾¹æ è°ƒæ•´ ========== */
        .sidebar {
            background-color: #fff;
            border-right: 1px solid var(--bjfu-border);
            height: 100vh;
            position: fixed;
            top: 56px;
            left: 0;
            width: 220px;
            padding-top: 20px;
            box-shadow: 2px 0 8px var(--bjfu-shadow);
            z-index: 100;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid var(--bjfu-border);
            margin-bottom: 20px;
        }

        .sidebar-header h4 {
            font-weight: 600;
            color: var(--bjfu-primary);
        }

        .sidebar-menu {
            list-style: none;
            padding: 0 20px;
            margin: 0;
        }

        .sidebar-menu li {
            margin-bottom: 8px;
        }

        .sidebar-menu a {
            color: var(--bjfu-text);
            text-decoration: none;
            display: block;
            padding: 12px 15px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .sidebar-menu a:hover, .sidebar-menu a.active {
            background-color: var(--bjfu-primary);
            color: white;
        }

        .sidebar-menu a i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        /* ========== ä¸»å†…å®¹åŒºè°ƒæ•´ ========== */
        .main-content {
            margin-left: 220px;
            margin-top: 56px;
            padding: 30px;
        }

        .page-header {
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--bjfu-dark);
            position: relative;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .page-title::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 4px;
            background: var(--bjfu-gradient);
            border-radius: 2px;
        }

        .breadcrumb {
            background: transparent;
            padding: 0;
            margin-bottom: 10px;
        }

        .breadcrumb-item a {
            color: var(--bjfu-primary);
            text-decoration: none;
        }

        /* ========== å¡ç‰‡æ ·å¼ ========== */
        .content-card {
            background: white;
            border: 2px solid transparent;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            padding: 20px;
            margin-bottom: 1.5rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .content-card:hover {
            transform: translateY(-8px);
            border-color: var(--bjfu-primary);
            box-shadow: 0 8px 20px rgba(10, 94, 56, 0.15);
        }

        .chart-card {
            height: 400px;
        }

        /* ========== æŒ‰é’®æ ·å¼ ========== */
        .btn-park {
            background: var(--bjfu-gradient);
            border: none;
            color: white;
            font-weight: 600;
            padding: 0.6rem 1.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(10, 94, 56, 0.2);
            position: relative;
            overflow: hidden;
        }

        .btn-park::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }

        .btn-park:hover {
            background: linear-gradient(135deg, #147D4C 0%, #0A5E38 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(10, 94, 56, 0.3);
        }

        .btn-park:hover::before {
            left: 100%;
        }

        .btn-park:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(10, 94, 56, 0.2);
        }

        .btn-outline-primary {
            border-color: var(--bjfu-primary);
            color: var(--bjfu-primary);
        }

        .btn-outline-primary:hover {
            background-color: var(--bjfu-primary);
            border-color: var(--bjfu-primary);
        }

        .btn-danger-custom {
            background-color: #dc3545;
            border: none;
            color: white;
            font-weight: 600;
            padding: 0.6rem 1.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.2);
        }

        .btn-danger-custom:hover {
            background-color: #bb2d3b;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(220, 53, 69, 0.3);
        }

        /* ========== è¡¨æ ¼æ ·å¼ ========== */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: var(--bjfu-gradient);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            border: none;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--bjfu-border);
            border-left: 1px solid var(--bjfu-border);
            border-right: 1px solid var(--bjfu-border);
        }

        .data-table tr:hover {
            background-color: var(--bjfu-light);
            transform: scale(1.002);
            transition: all 0.2s ease;
        }

        /* ========== å¾½ç« æ ·å¼è°ƒæ•´ ========== */
        .badge {
            padding: 0.4em 0.8em;
            font-weight: 600;
            border-radius: 20px;
            font-size: 0.85em;
        }

        /* é€‚é…åº¦è¯„åˆ†å¾½ç«  */
        .badge-score-high { background-color: var(--bjfu-primary); color: white; }
        .badge-score-mid { background-color: var(--bjfu-accent); color: #333; }
        .badge-score-low { background-color: #e76f51; color: white; }

        .badge-danger-custom {
            background-color: #dc3545 !important;
        }

        .badge-warning-custom {
            background-color: var(--bjfu-accent) !important;
            color: #333;
        }

        .badge-success-custom {
            background-color: var(--bjfu-primary) !important;
        }

        /* ========== åŠ è½½æ ·å¼ ========== */
        .loading { text-align: center; padding: 50px 0; color: #666; }

        /* ========== å¼¹çª—æ ·å¼ ========== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }

        .modal-content {
            background: white;
            border: none;
            border-radius: 12px;
            width: 80%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 0;
            box-shadow: 0 10px 30px rgba(10, 94, 56, 0.2);
        }

        .modal-header {
            background: var(--bjfu-gradient);
            color: white;
            padding: 1rem 1.5rem;
            font-weight: 600;
            font-size: 1.1rem;
            border-bottom: none;
            position: relative;
            overflow: hidden;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header::after {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            width: 60px;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            transform: skewX(-15deg);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: white;
            z-index: 1;
        }

        .modal-body-content {
            padding: 20px;
        }

        .species-tag {
            display: inline-block;
            background: var(--bjfu-light);
            border-radius: 6px;
            padding: 4px 8px;
            margin: 0 4px 4px 0;
            color: var(--bjfu-primary);
        }

        /* ========== è¡¨å•æ§ä»¶æ ·å¼ ========== */
        .form-control, .form-select {
            border: 1px solid var(--bjfu-border);
            border-radius: 6px;
            padding: 0.6rem 0.8rem;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--bjfu-primary);
            box-shadow: 0 0 0 0.25rem rgba(10, 94, 56, 0.15);
            outline: none;
        }

        .form-label {
            font-weight: 600;
            color: var(--bjfu-dark);
            margin-bottom: 0.3rem;
        }

        /* ========== é¡µè„šæ ·å¼ ========== */
        footer {
            margin-top: 3rem;
            padding: 1.5rem 0;
            background: var(--bjfu-primary);
            color: white;
            text-align: center;
            font-size: 0.9rem;
            margin-left: 220px;
        }

        /* ========== å“åº”å¼è®¾è®¡ ========== */
        @media (max-width: 768px) {
            .sidebar {
                width: 180px;
            }

            .main-content, footer {
                margin-left: 180px;
            }

            .navbar-brand {
                font-size: 1.2rem;
                padding-left: 35px;
            }

            .card-body {
                padding: 1rem;
            }

            .page-title {
                font-size: 1.5rem;
            }

            .btn-park {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 576px) {
            .sidebar {
                display: none;
            }

            .main-content, footer {
                margin-left: 0;
                padding: 15px;
            }

            .d-flex.justify-content-between {
                flex-direction: column;
                gap: 1rem;
            }
        }

        /* ========== æ‰“å°æ ·å¼ ========== */
        @media print {
            .btn-park, .navbar, .sidebar, .modal, footer {
                display: none !important;
            }

            .main-content {
                margin-left: 0;
                margin-top: 0;
                padding: 0;
            }

            .content-card {
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ ï¼ˆåŒ—æ—ä¸»é¢˜ï¼‰ -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-success fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">ç”Ÿç‰©å¤šæ ·æ€§ç›‘æµ‹ç³»ç»Ÿ</a>
            <div class="navbar-collapse">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/">é¦–é¡µ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/species">ç‰©ç§ç®¡ç†</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/monitor">ç›‘æµ‹è®°å½•</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/habitat">æ –æ¯åœ°åˆ†æ</a>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="logout()"><i class="bi bi-box-arrow-right"></i> é€€å‡ºç™»å½•</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h4><i class="bi bi-tree me-2"></i>åŠŸèƒ½èœå•</h4>
        </div>
        <ul class="sidebar-menu">
            <li><a href="/"><i class="bi bi-house"></i>é¦–é¡µ</a></li>
            <li><a href="/species"><i class="bi bi-paw"></i>ç‰©ç§ç®¡ç†</a></li>
            <li><a href="/monitor"><i class="bi bi-journal-text"></i>ç›‘æµ‹è®°å½•</a></li>
            <li><a href="/habitat" class="active"><i class="bi bi-map"></i>æ –æ¯åœ°åˆ†æ</a></li>
        </ul>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-content">
        <div class="page-header">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">é¦–é¡µ</a></li>
                    <li class="breadcrumb-item active" aria-current="page">æ –æ¯åœ°åˆ†æ</li>
                </ol>
            </nav>
            <h2 class="page-title">æ –æ¯åœ°åˆ†ææŠ¥å‘Š</h2>
        </div>

        <!-- ç­›é€‰åŒºï¼ˆæ–°å¢ç‰©ç§ç­›é€‰ + æ–°å¢æ –æ¯åœ°æŒ‰é’®ï¼‰ -->
        <div class="content-card">
            <div class="d-flex justify-content-between mb-3">
                <h5 class="mb-0"><i class="bi bi-filter me-2"></i>æ•°æ®ç­›é€‰</h5>
                <button type="button" class="btn btn-park" onclick="openHabitatModal('add')">
                    <i class="bi bi-plus-circle me-1"></i>æ–°å¢æ –æ¯åœ°
                </button>
            </div>
            <form id="searchForm" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label fw-medium">ç”Ÿæ€ç±»å‹</label>
                    <select class="form-select" id="searchEcoType">
                        <option value="all" selected>å…¨éƒ¨ç”Ÿæ€ç±»å‹</option>
                        <!-- åŠ¨æ€åŠ è½½ç”Ÿæ€ç±»å‹é€‰é¡¹ -->
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-medium">å…³è”ç‰©ç§</label>
                    <select class="form-select" id="searchSpecies">
                        <option value="all" selected>å…¨éƒ¨ç‰©ç§</option>
                        <!-- åŠ¨æ€åŠ è½½ç‰©ç§é€‰é¡¹ -->
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-medium">åˆ†æç»´åº¦</label>
                    <select class="form-select" id="searchDimension">
                        <option value="area" selected>é¢ç§¯åˆ†å¸ƒ</option>
                        <option value="score">é€‚å®œæ€§è¯„åˆ†</option>
                        <option value="threat">å—å¨èƒç¨‹åº¦</option>
                        <option value="species">ç‰©ç§æ•°é‡</option> <!-- æ–°å¢ç‰©ç§æ•°é‡ç»´åº¦ -->
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-medium">&nbsp;</label>
                    <button type="button" class="btn btn-park w-100" onclick="analysisHabitat()">
                        <i class="bi bi-bar-chart me-1"></i>åˆ†æ
                    </button>
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-medium">&nbsp;</label>
                    <button type="button" class="btn btn-outline-secondary w-100" onclick="exportReport()">
                        <i class="bi bi-download me-1"></i>å¯¼å‡ºæŠ¥å‘Š
                    </button>
                </div>
            </form>
        </div>

        <!-- å›¾è¡¨å±•ç¤ºåŒºï¼ˆæ–°å¢ç‰©ç§æ•°é‡å›¾è¡¨ï¼‰ -->
        <div class="row g-4">
            <!-- é¥¼å›¾ï¼šé¢ç§¯/è¯„åˆ†/å¨èƒç¨‹åº¦/ç‰©ç§æ•°é‡å æ¯” -->
            <div class="col-md-6">
                <div class="content-card chart-card">
                    <h5 class="card-title fw-medium mb-3"><i class="bi bi-pie-chart me-2"></i>æ –æ¯åœ°é¢ç§¯åˆ†å¸ƒå æ¯”</h5>
                    <div id="pieChart" style="width: 100%; height: 350px;"></div>
                </div>
            </div>
            <!-- æŸ±çŠ¶å›¾ï¼šé€‚å®œæ€§è¯„åˆ†/ç‰©ç§æ•°é‡ -->
            <div class="col-md-6">
                <div class="content-card chart-card">
                    <h5 class="card-title fw-medium mb-3"><i class="bi bi-bar-chart me-2"></i>æ –æ¯åœ°é€‚å®œæ€§è¯„åˆ†</h5>
                    <div id="barChart" style="width: 100%; height: 350px;"></div>
                </div>
            </div>
            <!-- æ–°å¢ï¼šç‰©ç§æ•°é‡åˆ†å¸ƒå›¾è¡¨ -->
            <div class="col-md-12">
                <div class="content-card chart-card">
                    <h5 class="card-title fw-medium mb-3"><i class="bi bi-columns me-2"></i>æ –æ¯åœ°å…³è”ç‰©ç§æ•°é‡åˆ†å¸ƒ</h5>
                    <div id="speciesCountChart" style="width: 100%; height: 350px;"></div>
                </div>
            </div>
        </div>

        <!-- è¯¦ç»†æ•°æ®åŒºï¼ˆæ–°å¢ç‰©ç§å…³è”æ“ä½œåˆ— + æ –æ¯åœ°ç¼–è¾‘/åˆ é™¤ï¼‰ -->
        <div class="content-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title fw-medium mb-0"><i class="bi bi-table me-2"></i>æ –æ¯åœ°è¯¦ç»†æ•°æ®</h5>
                <div>
                    <button type="button" class="btn btn-sm btn-park me-2" onclick="batchRelateSpecies()">
                        <i class="bi bi-link me-1"></i>æ‰¹é‡å…³è”ç‰©ç§
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="refreshHabitatData()">
                        <i class="bi bi-arrow-clockwise me-1"></i>åˆ·æ–°æ•°æ®
                    </button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>æ –æ¯åœ°ID</th>
                            <th>åŒºåŸŸID</th>
                            <th>ç”Ÿæ€ç±»å‹</th>
                            <th>é¢ç§¯(å…¬é¡·)</th>
                            <th>é€‚å®œæ€§è¯„åˆ†</th>
                            <th>å—å¨èƒç¨‹åº¦</th>
                            <th>å…³è”ç‰©ç§æ•°</th>
                            <th>ä¸»è¦ç‰©ç§</th>
                            <th>æ –æ¯åœ°ç®¡ç†</th>
                            <th>ç‰©ç§ç®¡ç†</th>
                        </tr>
                    </thead>
                    <tbody id="habitatTableBody">
                        <tr class="loading">
                            <td colspan="10">åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ç‰©ç§å…³è”å¼¹çª— -->
    <div class="modal-overlay" id="speciesRelateModal">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="modalTitle">ç®¡ç†æ –æ¯åœ°å…³è”ç‰©ç§</h4>
                <button class="modal-close" onclick="closeSpeciesModal()">&times;</button>
            </div>
            <div class="modal-body-content" id="modalBody">
                <!-- å¼¹çª—å†…å®¹åŠ¨æ€åŠ è½½ -->
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- æ –æ¯åœ°ç¼–è¾‘/æ–°å¢å¼¹çª— -->
    <div class="modal-overlay" id="habitatModal">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="habitatModalTitle">æ–°å¢æ –æ¯åœ°ä¿¡æ¯</h4>
                <button class="modal-close" onclick="closeHabitatModal()">&times;</button>
            </div>
            <div class="modal-body-content">
                <form id="habitatForm" class="row g-4">
                    <input type="hidden" id="habitatId">

                    <div class="col-md-6">
                        <label class="form-label">åŒºåŸŸID <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="regionId" placeholder="è¯·è¾“å…¥åŒºåŸŸID" required>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">ç”Ÿæ€ç±»å‹ <span class="text-danger">*</span></label>
                        <select class="form-select" id="ecologicalType" required>
                            <option value="">è¯·é€‰æ‹©ç”Ÿæ€ç±»å‹</option>
                            <option value="æ£®æ—">æ£®æ—</option>
                            <option value="æ¹¿åœ°">æ¹¿åœ°</option>
                            <option value="è‰åŸ">è‰åŸ</option>
                            <option value="è’æ¼ ">è’æ¼ </option>
                            <option value="å†œç”°">å†œç”°</option>
                            <option value="åŸå¸‚ç»¿åœ°">åŸå¸‚ç»¿åœ°</option>
                            <option value="æ²³æµæ¹–æ³Š">æ²³æµæ¹–æ³Š</option>
                            <option value="æµ·å²¸å¸¦">æµ·å²¸å¸¦</option>
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">é¢ç§¯(å…¬é¡·) <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="area" min="0.01" step="0.01" placeholder="è¯·è¾“å…¥æ –æ¯åœ°é¢ç§¯" required>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">é€‚å®œæ€§è¯„åˆ† <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="suitabilityScore" min="0" max="10" step="0.1" placeholder="0-10åˆ†" required>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">å—å¨èƒç¨‹åº¦ <span class="text-danger">*</span></label>
                        <select class="form-select" id="threatLevel" required>
                            <option value="">è¯·é€‰æ‹©å¨èƒç¨‹åº¦</option>
                            <option value="ä½å¨èƒ">ä½å¨èƒ</option>
                            <option value="ä¸­åº¦å¨èƒ">ä¸­åº¦å¨èƒ</option>
                            <option value="é«˜å¨èƒ">é«˜å¨èƒ</option>
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">æ ¸å¿ƒä¿æŠ¤èŒƒå›´(å…¬é¡·)</label>
                        <input type="number" class="form-control" id="coreProtection" min="0" step="0.01" placeholder="å¯é€‰å¡«">
                    </div>

                    <div class="col-md-12">
                        <label class="form-label">æ –æ¯åœ°æè¿°</label>
                        <textarea class="form-control" id="description" rows="3" placeholder="è¯·è¾“å…¥æ –æ¯åœ°è¯¦ç»†æè¿°ï¼ˆå¯é€‰ï¼‰"></textarea>
                    </div>

                    <div class="col-md-12 text-end">
                        <button type="button" class="btn btn-outline-secondary me-2" onclick="closeHabitatModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-park">ä¿å­˜ä¿¡æ¯</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- é¡µè„š -->
    <footer>
        <div class="container">
            <p>Â© 2025 åŒ—äº¬æ—ä¸šå¤§å­¦ - ç”Ÿç‰©å¤šæ ·æ€§ç›‘æµ‹ç³»ç»Ÿ | ç‰ˆæƒæ‰€æœ‰</p>
        </div>
    </footer>

    <script>
        // å…¨å±€å˜é‡
        let pieChartInstance, barChartInstance, speciesCountChartInstance;
        let allHabitatData = []; // å­˜å‚¨ä»åç«¯è·å–çš„æ‰€æœ‰æ –æ¯åœ°æ•°æ®
        let allSpeciesData = []; // æ‰€æœ‰ç‰©ç§æ•°æ®
        let currentHabitatId = ''; // å½“å‰æ“ä½œçš„æ –æ¯åœ°ID
        let currentModalType = ''; // add:æ–°å¢ edit:ç¼–è¾‘

        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('user');
            alert('å·²é€€å‡ºç™»å½•');
            // ç§»é™¤ç™»å½•è·³è½¬é€»è¾‘ï¼Œä»…æ¸…é™¤localStorage
        }

        // é¡µé¢åŠ è½½åˆå§‹åŒ–
        window.onload = function() {
            // åˆå§‹åŒ–å›¾è¡¨å®ä¾‹ï¼ˆç©ºæ•°æ®ï¼‰
            initEmptyCharts();
            // åŠ è½½ç”Ÿæ€ç±»å‹ä¸‹æ‹‰æ¡†
            loadEcoTypes();
            // åŠ è½½ç‰©ç§ä¸‹æ‹‰æ¡†
            loadSpeciesList();
            // åŠ è½½æ –æ¯åœ°æ•°æ®
            loadHabitatData('all', 'all');
            // ç»‘å®šæ –æ¯åœ°è¡¨å•æäº¤äº‹ä»¶
            document.getElementById('habitatForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveHabitatInfo();
            });
        }

        // åˆå§‹åŒ–ç©ºå›¾è¡¨ï¼ˆé¿å…åŠ è½½æ—¶ç©ºç™½ï¼‰
        function initEmptyCharts() {
            // é¥¼å›¾
            pieChartInstance = echarts.init(document.getElementById('pieChart'));
            pieChartInstance.setOption({
                title: { show: false },
                tooltip: { trigger: 'item' },
                legend: { orient: 'vertical', left: 'left' },
                series: [{ name: 'é¢ç§¯', type: 'pie', radius: ['40%', '70%'], data: [] }]
            });

            // æŸ±çŠ¶å›¾
            barChartInstance = echarts.init(document.getElementById('barChart'));
            barChartInstance.setOption({
                title: { show: false },
                tooltip: { trigger: 'axis' },
                legend: { data: ['é€‚å®œæ€§è¯„åˆ†'] },
                xAxis: { type: 'category', data: [] },
                yAxis: { type: 'value', min: 0, max: 10 },
                series: [{ name: 'é€‚å®œæ€§è¯„åˆ†', type: 'bar', data: [] }]
            });

            // ç‰©ç§æ•°é‡å›¾è¡¨
            speciesCountChartInstance = echarts.init(document.getElementById('speciesCountChart'));
            speciesCountChartInstance.setOption({
                title: { show: false },
                tooltip: { trigger: 'axis' },
                legend: { data: ['æ€»ç‰©ç§æ•°', 'ä¸»è¦ç‰©ç§æ•°'] },
                xAxis: { type: 'category', data: [] },
                yAxis: { type: 'value', min: 0 },
                series: [
                    { name: 'æ€»ç‰©ç§æ•°', type: 'bar', data: [] },
                    { name: 'ä¸»è¦ç‰©ç§æ•°', type: 'bar', data: [] }
                ]
            });

            // è‡ªé€‚åº”çª—å£
            window.addEventListener('resize', () => {
                pieChartInstance.resize();
                barChartInstance.resize();
                speciesCountChartInstance.resize();
            });
        }

        // åŠ è½½ç”Ÿæ€ç±»å‹ä¸‹æ‹‰æ¡†
        function loadEcoTypes() {
            fetch('/api/habitat/types')
                .then(res => res.json())
                .then(response => {
                    if (response.code === 200 && response.data.length > 0) {
                        const select = document.getElementById('searchEcoType');
                        response.data.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item.type;
                            option.textContent = item.type;
                            select.appendChild(option);
                        });
                    }
                })
                .catch(err => console.error('åŠ è½½ç”Ÿæ€ç±»å‹å¤±è´¥ï¼š', err));
        }

        // åŠ è½½ç‰©ç§ä¸‹æ‹‰æ¡†
        function loadSpeciesList() {
            fetch('/api/species?page=1&size=1000')
                .then(res => res.json())
                .then(response => {
                    if (response.code === 200 && response.data.length > 0) {
                        allSpeciesData = response.data;
                        const select = document.getElementById('searchSpecies');
                        response.data.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item.speciesId;
                            option.textContent = item.chineseName;
                            select.appendChild(option);
                        });
                    }
                })
                .catch(err => console.error('åŠ è½½ç‰©ç§åˆ—è¡¨å¤±è´¥ï¼š', err));
        }

        // åŠ è½½æ –æ¯åœ°æ•°æ®ï¼ˆæ–°å¢ç‰©ç§ç­›é€‰å‚æ•°ï¼‰
        function loadHabitatData(ecoType, speciesId) {
            // æ‹¼æ¥è¯·æ±‚å‚æ•°
            const params = new URLSearchParams({
                type: ecoType,
                speciesId: speciesId !== 'all' ? speciesId : ''
            });

            fetch(`/api/habitat/list?${params}`)
                .then(res => {
                    if (!res.ok) throw new Error('æ¥å£è¯·æ±‚å¤±è´¥');
                    return res.json();
                })
                .then(response => {
                    if (response.code === 200) {
                        allHabitatData = response.data;
                        // è¡¥å……åŠ è½½æ¯ä¸ªæ –æ¯åœ°çš„ç‰©ç§å…³è”æ•°æ®
                        loadHabitatSpeciesRelation().then(() => {
                            // æ¸²æŸ“è¡¨æ ¼
                            renderHabitatTable(allHabitatData);
                            // åˆå§‹åŒ–å›¾è¡¨
                            initCharts(allHabitatData);
                        });
                    } else {
                        alert('æ•°æ®æŸ¥è¯¢å¤±è´¥ï¼š' + response.msg);
                        renderEmptyTable();
                    }
                })
                .catch(err => {
                    console.error('è¯·æ±‚å¼‚å¸¸ï¼š', err);
                    alert('ç½‘ç»œå¼‚å¸¸ï¼Œæ— æ³•è·å–æ•°æ®ï¼š' + err.message);
                    renderEmptyTable();
                });
        }

        // åˆ·æ–°æ –æ¯åœ°æ•°æ®
        function refreshHabitatData() {
            const selectedType = document.getElementById('searchEcoType').value;
            const selectedSpecies = document.getElementById('searchSpecies').value;
            loadHabitatData(selectedType, selectedSpecies);
            alert('æ•°æ®å·²åˆ·æ–°ï¼');
        }

        // åŠ è½½æ –æ¯åœ°-ç‰©ç§å…³è”æ•°æ®
        function loadHabitatSpeciesRelation() {
            const promises = allHabitatData.map(habitat => {
                return fetch(`/api/habitat/${habitat.habitatId}/species`)
                    .then(res => res.json())
                    .then(response => {
                        if (response.code === 200) {
                            habitat.relatedSpecies = response.data;
                            habitat.speciesCount = response.totalSpeciesCount || 0;
                            habitat.mainSpeciesCount = response.mainSpeciesCount || 0;
                            // è·å–ä¸»è¦ç‰©ç§åç§°
                            habitat.mainSpeciesNames = response.data
                                .filter(s => s.isMain === 1)
                                .map(s => s.speciesName)
                                .slice(0, 3)
                                .join('ã€');
                            if (response.data.length > 3 && habitat.mainSpeciesNames) {
                                habitat.mainSpeciesNames += '...';
                            }
                        } else {
                            habitat.relatedSpecies = [];
                            habitat.speciesCount = 0;
                            habitat.mainSpeciesCount = 0;
                            habitat.mainSpeciesNames = 'æ— ';
                        }
                        return habitat;
                    })
                    .catch(err => {
                        console.error(`åŠ è½½æ –æ¯åœ°${habitat.habitatId}ç‰©ç§å…³è”å¤±è´¥ï¼š`, err);
                        habitat.relatedSpecies = [];
                        habitat.speciesCount = 0;
                        habitat.mainSpeciesCount = 0;
                        habitat.mainSpeciesNames = 'æ— ';
                        return habitat;
                    });
            });
            return Promise.all(promises);
        }

        // æ¸²æŸ“ç©ºè¡¨æ ¼
        function renderEmptyTable() {
            const tableBody = document.getElementById('habitatTableBody');
            tableBody.innerHTML = '<tr><td colspan="10" class="text-center py-3">æš‚æ— æ•°æ®</td></tr>';
        }

        // æ¸²æŸ“æ –æ¯åœ°è¡¨æ ¼ï¼ˆæ–°å¢æ –æ¯åœ°ç®¡ç†åˆ—ï¼‰
        function renderHabitatTable(data) {
            const tableBody = document.getElementById('habitatTableBody');
            tableBody.innerHTML = '';

            if (!data || data.length === 0) {
                renderEmptyTable();
                return;
            }

            data.forEach(item => {
                // é€‚é…åº¦è¯„åˆ†å¾½ç« 
                let scoreBadge;
                if (item.suitabilityScore >= 9) {
                    scoreBadge = `<span class="badge badge-score-high">${item.suitabilityScore}</span>`;
                } else if (item.suitabilityScore >= 7) {
                    scoreBadge = `<span class="badge badge-score-mid">${item.suitabilityScore}</span>`;
                } else {
                    scoreBadge = `<span class="badge badge-score-low">${item.suitabilityScore}</span>`;
                }

                // å¨èƒç¨‹åº¦å¾½ç« 
                let threatBadge;
                if (item.threatLevel === 'ä½å¨èƒ') {
                    threatBadge = '<span class="badge badge-success-custom">ä½å¨èƒ</span>';
                } else if (item.threatLevel === 'ä¸­åº¦å¨èƒ') {
                    threatBadge = '<span class="badge badge-warning-custom">ä¸­åº¦å¨èƒ</span>';
                } else {
                    threatBadge = '<span class="badge badge-danger-custom">é«˜å¨èƒ</span>';
                }

                // ç‰©ç§æ•°é‡å¾½ç« 
                let speciesCountBadge = `<span class="badge badge-success-custom">${item.speciesCount || 0}</span>`;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.habitatId || '-'}</td>
                    <td>${item.regionId || '-'}</td>
                    <td>${item.ecologicalType || '-'}</td>
                    <td>${item.area.toFixed(2) || '-'}</td>
                    <td>${scoreBadge}</td>
                    <td>${threatBadge}</td>
                    <td>${speciesCountBadge}</td>
                    <td>${item.mainSpeciesNames || 'æ— '}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="openHabitatModal('edit', '${item.habitatId}')">
                            <i class="bi bi-pencil-square me-1"></i>ç¼–è¾‘
                        </button>
                        <button class="btn btn-sm btn-danger-custom" onclick="deleteHabitat('${item.habitatId}')">
                            <i class="bi bi-trash me-1"></i>åˆ é™¤
                        </button>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-park me-2" onclick="openSpeciesModal('${item.habitatId}')">
                            <i class="bi bi-link me-1"></i>å…³è”ç‰©ç§
                        </button>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewSpeciesDetail('${item.habitatId}')">
                            <i class="bi bi-eye me-1"></i>æŸ¥çœ‹è¯¦æƒ…
                        </button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }

        // åˆå§‹åŒ–å›¾è¡¨ï¼ˆæ–°å¢ç‰©ç§æ•°é‡ç»´åº¦ï¼‰
        function initCharts(data) {
            if (!data || data.length === 0) return;

            // è·å–åˆ†æç»´åº¦
            const selectedDimension = document.getElementById('searchDimension').value;

            // ========== é¥¼å›¾ï¼šæ ¹æ®ç»´åº¦å±•ç¤ºä¸åŒæ•°æ® ==========
            let pieTitle = 'æ –æ¯åœ°é¢ç§¯åˆ†å¸ƒå æ¯”';
            let pieData = [];

            if (selectedDimension === 'area') {
                // é¢ç§¯åˆ†å¸ƒ
                pieTitle = 'æ –æ¯åœ°é¢ç§¯åˆ†å¸ƒå æ¯”';
                const sortedAreaData = [...data].sort((a, b) => b.area - a.area).slice(0, 8);
                pieData = sortedAreaData.map(item => ({
                    value: item.area,
                    name: item.ecologicalType.length > 6 ? item.ecologicalType.substring(0, 6) + '...' : item.ecologicalType
                }));
            } else if (selectedDimension === 'score') {
                // é€‚å®œæ€§è¯„åˆ†å æ¯”
                pieTitle = 'æ –æ¯åœ°é€‚å®œæ€§è¯„åˆ†å æ¯”';
                const sortedScoreData = [...data].sort((a, b) => b.suitabilityScore - a.suitabilityScore).slice(0, 8);
                pieData = sortedScoreData.map(item => ({
                    value: item.suitabilityScore,
                    name: item.ecologicalType.length > 6 ? item.ecologicalType.substring(0, 6) + '...' : item.ecologicalType
                }));
            } else if (selectedDimension === 'threat') {
                // å—å¨èƒç¨‹åº¦å æ¯”
                pieTitle = 'æ –æ¯åœ°å—å¨èƒç¨‹åº¦é¢ç§¯å æ¯”';
                const threatMap = { 'ä½å¨èƒ': [], 'ä¸­åº¦å¨èƒ': [], 'é«˜å¨èƒ': [] };
                data.forEach(item => {
                    threatMap[item.threatLevel].push(item);
                });
                pieData = [
                    { name: 'ä½å¨èƒ', value: threatMap['ä½å¨èƒ'].reduce((sum, item) => sum + item.area, 0) },
                    { name: 'ä¸­åº¦å¨èƒ', value: threatMap['ä¸­åº¦å¨èƒ'].reduce((sum, item) => sum + item.area, 0) },
                    { name: 'é«˜å¨èƒ', value: threatMap['é«˜å¨èƒ'].reduce((sum, item) => sum + item.area, 0) }
                ];
            } else if (selectedDimension === 'species') {
                // ç‰©ç§æ•°é‡å æ¯”
                pieTitle = 'æ –æ¯åœ°å…³è”ç‰©ç§æ•°é‡å æ¯”';
                const sortedSpeciesData = [...data].sort((a, b) => b.speciesCount - a.speciesCount).slice(0, 8);
                pieData = sortedSpeciesData.map(item => ({
                    value: item.speciesCount || 0,
                    name: item.ecologicalType.length > 6 ? item.ecologicalType.substring(0, 6) + '...' : item.ecologicalType
                }));
            }

            pieChartInstance.setOption({
                title: { text: pieTitle },
                tooltip: {
                    formatter: selectedDimension === 'area' ? '{b}<br/>é¢ç§¯ï¼š{c} å…¬é¡·<br/>å æ¯”ï¼š{d}%' :
                               selectedDimension === 'score' ? '{b}<br/>é€‚å®œæ€§è¯„åˆ†ï¼š{c}åˆ†<br/>å æ¯”ï¼š{d}%' :
                               selectedDimension === 'threat' ? '{b}<br/>é¢ç§¯ï¼š{c} å…¬é¡·<br/>å æ¯”ï¼š{d}%' :
                               '{b}<br/>ç‰©ç§æ•°é‡ï¼š{c}ä¸ª<br/>å æ¯”ï¼š{d}%'
                },
                series: [{
                    name: selectedDimension === 'area' ? 'é¢ç§¯' :
                           selectedDimension === 'score' ? 'é€‚å®œæ€§è¯„åˆ†' :
                           selectedDimension === 'threat' ? 'å¨èƒç­‰çº§é¢ç§¯' : 'ç‰©ç§æ•°é‡',
                    data: pieData,
                    itemStyle: {
                        color: function(params) {
                            // è‡ªå®šä¹‰é¥¼å›¾é¢œè‰²ï¼ˆåŒ—æ—è‰²ç³»ï¼‰
                            const colorList = [
                                '#0A5E38', '#147D4C', '#1AA85F',
                                '#FFC107', '#FFD700', '#E6F4EA'
                            ];
                            return colorList[params.dataIndex % colorList.length];
                        }
                    }
                }]
            });

            // ========== æŸ±çŠ¶å›¾ï¼šæ ¹æ®ç»´åº¦å±•ç¤ºä¸åŒæ•°æ® ==========
            let barTitle = 'æ –æ¯åœ°é€‚å®œæ€§è¯„åˆ†';
            let barXData = [];
            let barYData = [];
            let barLegend = ['é€‚å®œæ€§è¯„åˆ†'];
            let barYFormatter = '{value}åˆ†';

            if (selectedDimension === 'area') {
                barTitle = 'æ –æ¯åœ°é€‚å®œæ€§è¯„åˆ†';
                const sortedScoreData = [...data].sort((a, b) => b.suitabilityScore - a.suitabilityScore).slice(0, 8);
                barXData = sortedScoreData.map(item => item.ecologicalType.length > 6 ? item.ecologicalType.substring(0, 6) + '...' : item.ecologicalType);
                barYData = sortedScoreData.map(item => item.suitabilityScore);
            } else if (selectedDimension === 'score') {
                barTitle = 'æ –æ¯åœ°é¢ç§¯åˆ†å¸ƒ';
                const sortedAreaData = [...data].sort((a, b) => b.area - a.area).slice(0, 8);
                barXData = sortedAreaData.map(item => item.ecologicalType.length > 6 ? item.ecologicalType.substring(0, 6) + '...' : item.ecologicalType);
                barYData = sortedAreaData.map(item => item.area);
                barLegend = ['é¢ç§¯ï¼ˆå…¬é¡·ï¼‰'];
                barYFormatter = '{value} å…¬é¡·';
            } else if (selectedDimension === 'threat') {
                barTitle = 'å„å¨èƒç­‰çº§å¹³å‡é€‚å®œæ€§è¯„åˆ†';
                const threatMap = { 'ä½å¨èƒ': [], 'ä¸­åº¦å¨èƒ': [], 'é«˜å¨èƒ': [] };
                data.forEach(item => {
                    threatMap[item.threatLevel].push(item);
                });
                barXData = ['ä½å¨èƒ', 'ä¸­åº¦å¨èƒ', 'é«˜å¨èƒ'];
                barYData = [
                    threatMap['ä½å¨èƒ'].length > 0 ? (threatMap['ä½å¨èƒ'].reduce((sum, item) => sum + item.suitabilityScore, 0) / threatMap['ä½å¨èƒ'].length) : 0,
                    threatMap['ä¸­åº¦å¨èƒ'].length > 0 ? (threatMap['ä¸­åº¦å¨èƒ'].reduce((sum, item) => sum + item.suitabilityScore, 0) / threatMap['ä¸­åº¦å¨èƒ'].length) : 0,
                    threatMap['é«˜å¨èƒ'].length > 0 ? (threatMap['é«˜å¨èƒ'].reduce((sum, item) => sum + item.suitabilityScore, 0) / threatMap['é«˜å¨èƒ'].length) : 0
                ];
                barLegend = ['å¹³å‡é€‚å®œæ€§è¯„åˆ†'];
            } else if (selectedDimension === 'species') {
                barTitle = 'æ –æ¯åœ°å…³è”ç‰©ç§æ•°é‡';
                const sortedSpeciesData = [...data].sort((a, b) => b.speciesCount - a.speciesCount).slice(0, 8);
                barXData = sortedSpeciesData.map(item => item.ecologicalType.length > 6 ? item.ecologicalType.substring(0, 6) + '...' : item.ecologicalType);
                barYData = sortedSpeciesData.map(item => item.speciesCount || 0);
                barLegend = ['ç‰©ç§æ•°é‡'];
                barYFormatter = '{value}ä¸ª';
            }

            barChartInstance.setOption({
                title: { text: barTitle },
                tooltip: { formatter: '{b}<br/>' + barLegend[0] + 'ï¼š{c}' + barYFormatter.replace('{value}', '') },
                legend: { data: barLegend },
                xAxis: {
                    data: barXData,
                    axisLabel: { rotate: 30 }
                },
                yAxis: { axisLabel: { formatter: barYFormatter } },
                series: [{
                    name: barLegend[0],
                    data: barYData,
                    itemStyle: {
                        color: function(params) {
                            // è‡ªå®šä¹‰æŸ±çŠ¶å›¾é¢œè‰²ï¼ˆåŒ—æ—è‰²ç³»ï¼‰
                            const colorList = ['#0A5E38', '#147D4C', '#1AA85F'];
                            return colorList[params.dataIndex % colorList.length];
                        }
                    }
                }]
            });

            // ========== ç‰©ç§æ•°é‡åˆ†å¸ƒå›¾è¡¨ ==========
            const speciesChartData = [...data].sort((a, b) => b.speciesCount - a.speciesCount).slice(0, 10);
            const speciesXData = speciesChartData.map(item => item.habitatId);
            const totalSpeciesData = speciesChartData.map(item => item.speciesCount || 0);
            const mainSpeciesData = speciesChartData.map(item => item.mainSpeciesCount || 0);

            speciesCountChartInstance.setOption({
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        let res = params[0].name + '<br/>';
                        params.forEach(param => {
                            res += param.seriesName + 'ï¼š' + param.value + 'ä¸ª<br/>';
                        });
                        return res;
                    }
                },
                xAxis: {
                    data: speciesXData,
                    axisLabel: { rotate: 45 }
                },
                yAxis: { axisLabel: { formatter: '{value}ä¸ª' } },
                series: [
                    {
                        name: 'æ€»ç‰©ç§æ•°',
                        data: totalSpeciesData,
                        itemStyle: { color: '#0A5E38' }
                    },
                    {
                        name: 'ä¸»è¦ç‰©ç§æ•°',
                        data: mainSpeciesData,
                        itemStyle: { color: '#FFC107' }
                    }
                ]
            });
        }

        // åˆ†ææ –æ¯åœ°ï¼ˆæ–°å¢ç‰©ç§ç­›é€‰ï¼‰
        function analysisHabitat() {
            const selectedType = document.getElementById('searchEcoType').value;
            const selectedSpecies = document.getElementById('searchSpecies').value;
            const selectedDimension = document.getElementById('searchDimension').value;

            // é‡æ–°åŠ è½½ç­›é€‰åçš„æ•°æ®
            loadHabitatData(selectedType, selectedSpecies)
                .then(() => {
                    let filteredData = allHabitatData;
                    if (selectedType !== 'all') {
                        filteredData = filteredData.filter(item => item.ecologicalType === selectedType);
                    }

                    // é‡æ–°åˆå§‹åŒ–å›¾è¡¨
                    initCharts(filteredData);

                    alert(`å·²ç­›é€‰ã€${selectedType === 'all' ? 'å…¨éƒ¨ç”Ÿæ€ç±»å‹' : selectedType}ã€‘${selectedSpecies === 'all' ? '' : ' + ç‰©ç§ï¼š' + allSpeciesData.find(s => s.speciesId === selectedSpecies)?.chineseName}ï¼ŒæŒ‰ã€${
                        selectedDimension === 'area' ? 'é¢ç§¯åˆ†å¸ƒ' :
                        selectedDimension === 'score' ? 'é€‚å®œæ€§è¯„åˆ†' :
                        selectedDimension === 'threat' ? 'å—å¨èƒç¨‹åº¦' : 'ç‰©ç§æ•°é‡'
                    }ã€‘ç»´åº¦åˆ†æå®Œæˆï¼`);
                });
        }

        // ========== æ –æ¯åœ°ç®¡ç†æ ¸å¿ƒåŠŸèƒ½ ==========
        // æ‰“å¼€æ –æ¯åœ°ç¼–è¾‘/æ–°å¢å¼¹çª—
        function openHabitatModal(type, habitatId) {
            currentModalType = type;
            const modal = document.getElementById('habitatModal');
            const modalTitle = document.getElementById('habitatModalTitle');

            // é‡ç½®è¡¨å•
            document.getElementById('habitatForm').reset();
            document.getElementById('habitatId').value = '';

            if (type === 'add') {
                modalTitle.textContent = 'æ–°å¢æ –æ¯åœ°ä¿¡æ¯';
            } else if (type === 'edit') {
                modalTitle.textContent = 'ç¼–è¾‘æ –æ¯åœ°ä¿¡æ¯';
                // å¡«å……è¡¨å•æ•°æ®
                const habitat = allHabitatData.find(item => item.habitatId === habitatId);
                if (habitat) {
                    document.getElementById('habitatId').value = habitat.habitatId;
                    document.getElementById('regionId').value = habitat.regionId || '';
                    document.getElementById('ecologicalType').value = habitat.ecologicalType || '';
                    document.getElementById('area').value = habitat.area || '';
                    document.getElementById('suitabilityScore').value = habitat.suitabilityScore || '';
                    document.getElementById('threatLevel').value = habitat.threatLevel || '';
                    document.getElementById('coreProtection').value = habitat.coreProtection || '';
                    document.getElementById('description').value = habitat.description || '';
                }
            }

            modal.style.display = 'flex';
        }

        // å…³é—­æ –æ¯åœ°å¼¹çª—
        function closeHabitatModal() {
            const modal = document.getElementById('habitatModal');
            modal.style.display = 'none';
            currentModalType = '';
        }

        // ä¿å­˜æ –æ¯åœ°ä¿¡æ¯ï¼ˆæ–°å¢/ç¼–è¾‘ï¼‰
        function saveHabitatInfo() {
            const habitatId = document.getElementById('habitatId').value;
            const habitatData = {
                regionId: document.getElementById('regionId').value,
                ecologicalType: document.getElementById('ecologicalType').value,
                area: parseFloat(document.getElementById('area').value),
                suitabilityScore: parseFloat(document.getElementById('suitabilityScore').value),
                threatLevel: document.getElementById('threatLevel').value,
                coreProtection: document.getElementById('coreProtection').value ? parseFloat(document.getElementById('coreProtection').value) : 0,
                description: document.getElementById('description').value
            };

            // æ„å»ºè¯·æ±‚å‚æ•°
            let url = '/api/habitat';
            let method = 'POST';

            if (currentModalType === 'edit' && habitatId) {
                url = `/api/habitat/${habitatId}`;
                method = 'PUT';
                habitatData.habitatId = habitatId;
            }

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(habitatData)
            })
            .then(res => res.json())
            .then(response => {
                if (response.code === 200) {
                    alert(currentModalType === 'add' ? 'æ –æ¯åœ°æ–°å¢æˆåŠŸï¼' : 'æ –æ¯åœ°ç¼–è¾‘æˆåŠŸï¼');
                    closeHabitatModal();
                    // é‡æ–°åŠ è½½æ•°æ®
                    refreshHabitatData();
                } else {
                    alert('æ“ä½œå¤±è´¥ï¼š' + response.msg);
                }
            })
            .catch(err => {
                console.error('ä¿å­˜æ –æ¯åœ°ä¿¡æ¯å¤±è´¥ï¼š', err);
                alert('æ“ä½œå¤±è´¥ï¼š' + err.message);
            });
        }

        // åˆ é™¤æ –æ¯åœ°
        function deleteHabitat(habitatId) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ –æ¯åœ°ã€${habitatId}ã€‘å—ï¼Ÿæ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤è¯¥æ –æ¯åœ°çš„æ‰€æœ‰ç‰©ç§å…³è”æ•°æ®ï¼Œä¸”æ— æ³•æ¢å¤ï¼`)) {
                return;
            }

            fetch(`/api/habitat/${habitatId}`, {
                method: 'DELETE'
            })
            .then(res => res.json())
            .then(response => {
                if (response.code === 200) {
                    alert('æ –æ¯åœ°åˆ é™¤æˆåŠŸï¼');
                    // é‡æ–°åŠ è½½æ•°æ®
                    refreshHabitatData();
                } else {
                    alert('åˆ é™¤å¤±è´¥ï¼š' + response.msg);
                }
            })
            .catch(err => {
                console.error('åˆ é™¤æ –æ¯åœ°å¤±è´¥ï¼š', err);
                alert('åˆ é™¤å¤±è´¥ï¼š' + err.message);
            });
        }

        // ========== ç‰©ç§å…³è”ç›¸å…³åŠŸèƒ½ ==========
        // æ‰“å¼€ç‰©ç§å…³è”å¼¹çª—
        function openSpeciesModal(habitatId) {
            currentHabitatId = habitatId;
            const modal = document.getElementById('speciesRelateModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            modalTitle.textContent = `ç®¡ç†æ –æ¯åœ°ã€${habitatId}ã€‘å…³è”ç‰©ç§`;
            modalBody.innerHTML = '<div class="loading">åŠ è½½ç‰©ç§å…³è”æ•°æ®ä¸­...</div>';

            // åŠ è½½è¯¥æ –æ¯åœ°çš„ç‰©ç§å…³è”æ•°æ®
            fetch(`/api/habitat/${habitatId}/species`)
                .then(res => res.json())
                .then(response => {
                    if (response.code === 200) {
                        const relatedSpecies = response.data;

                        // æ„å»ºå¼¹çª—å†…å®¹
                        let html = `
                            <div class="row mb-4">
                                <div class="col-md-8">
                                    <select class="form-select" id="addSpeciesSelect">
                                        <option value="">é€‰æ‹©è¦å…³è”çš„ç‰©ç§</option>
                                        ${allSpeciesData.map(species => {
                                            const isRelated = relatedSpecies.some(r => r.speciesId === species.speciesId);
                                            return isRelated ? '' : `<option value="${species.speciesId}">${species.chineseName} (${species.protectionLevel})</option>`;
                                        }).join('')}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-park w-100" onclick="addSpeciesRelation()">
                                        <i class="bi bi-plus me-1"></i>æ·»åŠ å…³è”
                                    </button>
                                </div>
                            </div>

                            <div class="mb-3">
                                <h6>å·²å…³è”ç‰©ç§ï¼ˆå…±${relatedSpecies.length}ä¸ªï¼‰</h6>
                                <div class="table-responsive">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>ç‰©ç§ID</th>
                                                <th>ç‰©ç§åç§°</th>
                                                <th>ä¿æŠ¤çº§åˆ«</th>
                                                <th>æ˜¯å¦ä¸»è¦ç‰©ç§</th>
                                                <th>æ“ä½œ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${relatedSpecies.length > 0 ? relatedSpecies.map(species => `
                                                <tr>
                                                    <td>${species.speciesId}</td>
                                                    <td>${species.speciesName}</td>
                                                    <td>${species.protectionLevel}</td>
                                                    <td>
                                                        <button class="btn btn-sm ${species.isMain === 1 ? 'btn-success' : 'btn-outline-secondary'}"
                                                                onclick="toggleMainSpecies('${species.speciesId}', ${species.isMain})">
                                                            ${species.isMain === 1 ? 'æ˜¯' : 'å¦'}
                                                        </button>
                                                    </td>
                                                    <td>
                                                        <button class="btn btn-sm btn-danger" onclick="deleteSpeciesRelation('${species.speciesId}')">
                                                            <i class="bi bi-trash me-1"></i>è§£é™¤å…³è”
                                                        </button>
                                                    </td>
                                                </tr>
                                            `).join('') : `
                                                <tr>
                                                    <td colspan="5" class="text-center py-3">æš‚æ— å…³è”ç‰©ç§</td>
                                                </tr>
                                            `}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                        modalBody.innerHTML = html;
                    } else {
                        modalBody.innerHTML = `<div class="text-danger">åŠ è½½å¤±è´¥ï¼š${response.msg}</div>`;
                    }
                })
                .catch(err => {
                    console.error('åŠ è½½ç‰©ç§å…³è”æ•°æ®å¤±è´¥ï¼š', err);
                    modalBody.innerHTML = `<div class="text-danger">åŠ è½½å¤±è´¥ï¼š${err.message}</div>`;
                });

            modal.style.display = 'flex';
        }

        // å…³é—­ç‰©ç§å…³è”å¼¹çª—
        function closeSpeciesModal() {
            const modal = document.getElementById('speciesRelateModal');
            modal.style.display = 'none';
            currentHabitatId = '';
        }

        // æ·»åŠ ç‰©ç§å…³è”
        function addSpeciesRelation() {
            const speciesId = document.getElementById('addSpeciesSelect').value;
            if (!speciesId) {
                alert('è¯·é€‰æ‹©è¦å…³è”çš„ç‰©ç§ï¼');
                return;
            }

            fetch('/api/habitat/species/relation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    habitatId: currentHabitatId,
                    speciesId: speciesId,
                    isMain: 0
                })
            })
            .then(res => res.json())
            .then(response => {
                if (response.code === 200) {
                    alert('ç‰©ç§å…³è”æˆåŠŸï¼');
                    // é‡æ–°åŠ è½½å¼¹çª—æ•°æ®
                    openSpeciesModal(currentHabitatId);
                    // é‡æ–°åŠ è½½é¡µé¢æ•°æ®
                    refreshHabitatData();
                } else {
                    alert('å…³è”å¤±è´¥ï¼š' + response.msg);
                }
            })
            .catch(err => {
                console.error('æ·»åŠ ç‰©ç§å…³è”å¤±è´¥ï¼š', err);
                alert('å…³è”å¤±è´¥ï¼š' + err.message);
            });
        }

        // åˆ‡æ¢ä¸»è¦ç‰©ç§çŠ¶æ€
        function toggleMainSpecies(speciesId, isMain) {
            const newIsMain = isMain === 1 ? 0 : 1;

            fetch('/api/habitat/species/relation', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    habitatId: currentHabitatId,
                    speciesId: speciesId,
                    isMain: newIsMain
                })
            })
            .then(res => res.json())
            .then(response => {
                if (response.code === 200) {
                    alert(`å·²${newIsMain === 1 ? 'æ ‡è®°ä¸º' : 'å–æ¶ˆ'}ä¸»è¦ç‰©ç§ï¼`);
                    // é‡æ–°åŠ è½½å¼¹çª—æ•°æ®
                    openSpeciesModal(currentHabitatId);
                    // é‡æ–°åŠ è½½é¡µé¢æ•°æ®
                    refreshHabitatData();
                } else {
                    alert('æ“ä½œå¤±è´¥ï¼š' + response.msg);
                }
            })
            .catch(err => {
                console.error('åˆ‡æ¢ä¸»è¦ç‰©ç§å¤±è´¥ï¼š', err);
                alert('æ“ä½œå¤±è´¥ï¼š' + err.message);
            });
        }

        // åˆ é™¤ç‰©ç§å…³è”
        function deleteSpeciesRelation(speciesId) {
            if (!confirm('ç¡®å®šè¦è§£é™¤è¯¥ç‰©ç§çš„å…³è”å—ï¼Ÿ')) {
                return;
            }

            fetch('/api/habitat/species/relation', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    habitatId: currentHabitatId,
                    speciesId: speciesId
                })
            })
            .then(res => res.json())
            .then(response => {
                if (response.code === 200) {
                    alert('å…³è”å·²è§£é™¤ï¼');
                    // é‡æ–°åŠ è½½å¼¹çª—æ•°æ®
                    openSpeciesModal(currentHabitatId);
                    // é‡æ–°åŠ è½½é¡µé¢æ•°æ®
                    refreshHabitatData();
                } else {
                    alert('è§£é™¤å¤±è´¥ï¼š' + response.msg);
                }
            })
            .catch(err => {
                console.error('è§£é™¤ç‰©ç§å…³è”å¤±è´¥ï¼š', err);
                alert('è§£é™¤å¤±è´¥ï¼š' + err.message);
            });
        }

        // æŸ¥çœ‹ç‰©ç§è¯¦æƒ…
        function viewSpeciesDetail(habitatId) {
            const habitat = allHabitatData.find(h => h.habitatId === habitatId);
            if (!habitat || !habitat.relatedSpecies || habitat.relatedSpecies.length === 0) {
                alert('è¯¥æ –æ¯åœ°æš‚æ— å…³è”ç‰©ç§ï¼');
                return;
            }

            // æ„å»ºè¯¦æƒ…å¼¹çª—
            const modal = document.getElementById('speciesRelateModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            modalTitle.textContent = `æ –æ¯åœ°ã€${habitatId}ã€‘å…³è”ç‰©ç§è¯¦æƒ…`;

            // æŒ‰ä¸»è¦ç‰©ç§åˆ†ç»„
            const mainSpecies = habitat.relatedSpecies.filter(s => s.isMain === 1);
            const otherSpecies = habitat.relatedSpecies.filter(s => s.isMain === 0);

            let html = `
                <div class="mb-4">
                    <h6>åŸºæœ¬ä¿¡æ¯</h6>
                    <table class="table table-sm">
                        <tr>
                            <td width="150px">æ –æ¯åœ°ID</td>
                            <td>${habitat.habitatId}</td>
                            <td width="150px">ç”Ÿæ€ç±»å‹</td>
                            <td>${habitat.ecologicalType}</td>
                        </tr>
                        <tr>
                            <td>åŒºåŸŸID</td>
                            <td>${habitat.regionId}</td>
                            <td>é€‚å®œæ€§è¯„åˆ†</td>
                            <td>${habitat.suitabilityScore}</td>
                        </tr>
                        <tr>
                            <td>æ€»é¢ç§¯</td>
                            <td>${habitat.area.toFixed(2)} å…¬é¡·</td>
                            <td>å—å¨èƒç¨‹åº¦</td>
                            <td>${habitat.threatLevel}</td>
                        </tr>
                    </table>
                </div>

                <div>
                    <h6>ä¸»è¦ç‰©ç§ï¼ˆ${mainSpecies.length}ä¸ªï¼‰</h6>
                    <div class="mb-3">
                        ${mainSpecies.length > 0 ? mainSpecies.map(s => `
                            <div class="species-tag">
                                ${s.speciesName} (${s.protectionLevel})
                            </div>
                        `).join('') : 'æ— '}
                    </div>

                    <h6>å…¶ä»–å…³è”ç‰©ç§ï¼ˆ${otherSpecies.length}ä¸ªï¼‰</h6>
                    <div>
                        ${otherSpecies.length > 0 ? otherSpecies.map(s => `
                            <div class="species-tag">
                                ${s.speciesName} (${s.protectionLevel})
                            </div>
                        `).join('') : 'æ— '}
                    </div>
                </div>

                <div class="mt-4">
                    <button class="btn btn-park" onclick="openSpeciesModal('${habitatId}')">
                        <i class="bi bi-pencil me-1"></i>ç¼–è¾‘å…³è”ç‰©ç§
                    </button>
                </div>
            `;

            modalBody.innerHTML = html;
            modal.style.display = 'flex';
        }

        // æ‰¹é‡å…³è”ç‰©ç§ï¼ˆé¢„ç•™åŠŸèƒ½ï¼‰
        function batchRelateSpecies() {
            alert('æ‰¹é‡å…³è”ç‰©ç§åŠŸèƒ½å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼');
        }

        // å¯¼å‡ºæŠ¥å‘Šï¼ˆæ–°å¢ç‰©ç§å…³è”æ•°æ®ï¼‰
        function exportReport() {
            if (allHabitatData.length === 0) {
                alert('æš‚æ— æ•°æ®å¯å¯¼å‡ºï¼');
                return;
            }

            // æ„å»ºCSVå†…å®¹ï¼ˆæ–°å¢ç‰©ç§ç›¸å…³åˆ—ï¼‰
            const csvHeader = 'æ –æ¯åœ°ID,åŒºåŸŸID,ç”Ÿæ€ç±»å‹,é¢ç§¯(å…¬é¡·),æ ¸å¿ƒä¿æŠ¤èŒƒå›´,é€‚å®œæ€§è¯„åˆ†,å—å¨èƒç¨‹åº¦,å…³è”ç‰©ç§æ•°,ä¸»è¦ç‰©ç§æ•°,ä¸»è¦ç‰©ç§åç§°\n';
            const csvBody = allHabitatData.map(item => {
                return `${item.habitatId},${item.regionId},${item.ecologicalType},${item.area.toFixed(2)},${item.coreProtection || ''},${item.suitabilityScore},${item.threatLevel},${item.speciesCount || 0},${item.mainSpeciesCount || 0},"${item.mainSpeciesNames || 'æ— '}"`;
            }).join('\n');
            const csvContent = encodeURI('data:text/csv;charset=utf-8,\uFEFF' + csvHeader + csvBody);

            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const link = document.createElement('a');
            link.href = csvContent;
            link.download = 'æ –æ¯åœ°åˆ†ææŠ¥å‘Š_' + new Date().toLocaleDateString().replace(/\//g, '-') + '.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            alert('æ –æ¯åœ°åˆ†ææŠ¥å‘Šï¼ˆå«ç‰©ç§å…³è”æ•°æ®ï¼‰å·²æˆåŠŸå¯¼å‡ºä¸ºCSVæ–‡ä»¶ï¼');
        }

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        document.getElementById('speciesRelateModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSpeciesModal();
            }
        });

        document.getElementById('habitatModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeHabitatModal();
            }
        });
    </script>
</body>
</html>