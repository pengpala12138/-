<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>执法人员管理 - 智慧林草系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* 基础样式优化 */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }

        /* 导航栏优化 */
        .navbar {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .navbar-brand {
            font-weight: 600;
            font-size: 1.25rem;
        }

        .nav-link {
            transition: all 0.3s ease;
            margin: 0 4px;
        }

        .nav-link:hover {
            color: #ffffff !important;
            transform: translateY(-2px);
        }

        /* 卡片样式优化 */
        .card {
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        /* 按钮样式优化 */
        .btn {
            border-radius: 6px;
            transition: all 0.2s ease;
            padding: 8px 16px;
            font-size: 1rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-success {
            background-color: #147D4C;
            border-color: #147D4C;
        }

        .btn-primary {
            background-color: #0A5E38;
            border-color: #0A5E38;
        }

        .btn-primary:hover, .btn-success:hover {
            opacity: 0.9;
        }

        /* 表格样式优化 */
        .table {
            border-collapse: collapse;
            width: 100%;
            font-size: 0.9rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            background-color: white;
        }

        .table th, .table td {
            vertical-align: middle;
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .table thead {
            background-color: #0A5E38;
            color: white;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .table-hover tbody tr:hover {
            background-color: #f0f9f0;
        }

        /* 确保状态和操作列不换行 */
        .table td:nth-last-child(2),
        .table td:last-child,
        .table th:nth-last-child(2),
        .table th:last-child {
            white-space: nowrap;
            min-width: 100px;
        }

        /* 操作按钮样式 */
        .btn-view { background-color: #147D4C; border-color: #147D4C; color: white; }
        .btn-delete { background-color: #dc3545; border-color: #dc3545; color: white; }
        .btn-edit { background-color: #ffc107; border-color: #ffc107; color: #333; }

        /* 模态框样式优化 */
        .modal-content {
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
        }

        .modal-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        /* 分页样式优化 */
        .pagination {
            margin-top: 1rem;
            justify-content: center;
        }

        .pagination .page-link {
            color: #0A5E38;
            border-radius: 6px;
            margin: 0 3px;
        }

        .pagination .page-item.active .page-link {
            background-color: #0A5E38;
            border-color: #0A5E38;
        }

        /* 筛选栏样式优化 */
        .card-body.p-2 {
            padding: 1rem !important;
        }

        .form-select, .form-control {
            border-radius: 6px;
            transition: border-color 0.2s ease;
        }

        .form-select:focus, .form-control:focus {
            border-color: #147D4C;
            box-shadow: 0 0 0 3px rgba(0, 100, 0, 0.1);
        }

        /* 状态标签样式优化 */
        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #0A5E38;">
        <div class="container">
            <a class="navbar-brand" href="#">智慧林草系统</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <!-- 删除了首页选项 -->
                    <li class="nav-item"><a class="nav-link" href="illegal-records.html">非法行为记录</a></li>
                    <li class="nav-item"><a class="nav-link" href="law-dispatches.html">执法调度</a></li>
                    <li class="nav-item"><a class="nav-link active" href="law-enforcers.html">执法人员管理</a></li>
                    <li class="nav-item"><a class="nav-link" href="video-monitors.html">视频监控点管理</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-3">
        <!-- 页面标题 -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>执法人员管理</h2>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addEnforcerModal">新增执法人员</button>
        </div>

        <!-- 筛选栏 -->
        <div class="card mb-3">
            <div class="card-body p-2">
                <div class="row g-2 align-items-center">
                    <div class="col-md-3">
                        <input type="text" id="nameFilter" class="form-control form-control-sm" placeholder="输入姓名搜索">
                    </div>
                    <div class="col-md-3">
                        <select id="deptFilter" class="form-select form-select-sm">
                            <option value="">全部部门</option>
                            <option value="森林公安">森林公安</option>
                            <option value="环保执法">环保执法</option>
                            <option value="自然保护区管理局">自然保护区管理局</option>
                            <option value="野生动物保护站">野生动物保护站</option>
                        </select>
                    </div>
                    <div class="col-md-1">
                        <button id="searchBtn" class="btn btn-primary btn-sm w-100">查询</button>
                    </div>
                    <div class="col-md-5 text-end">
                        <span class="text-muted">共 <strong id="totalCount">0</strong> 名执法人员</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 数据表格 -->
        <div class="card">
            <div class="card-body p-2">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover table-sm">
                        <thead>
                            <tr>
                                <th>执法ID</th>
                                <th>姓名</th>
                                <th>所属部门</th>
                                <th>执法权限</th>
                                <th>联系电话</th>
                                <th>执法设备编号</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="enforcerTableBody">
                            <tr><td colspan="7" class="text-center">加载中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 分页控件 -->
        <div class="pagination-container">
            <ul class="pagination" id="pagination">
                <!-- 分页内容将通过JS动态生成 -->
            </ul>
        </div>

        <!-- 执法人员详情弹窗 -->
        <div class="modal fade" id="enforcerDetailModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" style="font-size: 1.2rem;">执法人员详情</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body detail-modal-body" style="font-size: 0.9rem;">
                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label fw-bold">执法ID</label>
                                    <p id="detail-office-id" class="form-control-plaintext"></p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label fw-bold">姓名</label>
                                    <p id="detail-name" class="form-control-plaintext"></p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label fw-bold">所属部门</label>
                                    <p id="detail-department" class="form-control-plaintext"></p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label fw-bold">执法权限</label>
                                    <p id="detail-authority" class="form-control-plaintext"></p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label fw-bold">联系电话</label>
                                    <p id="detail-contact" class="form-control-plaintext"></p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label fw-bold">执法设备编号</label>
                                    <p id="detail-device-no" class="form-control-plaintext"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">关闭</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 新增执法人员弹窗 -->
        <div class="modal fade" id="addEnforcerModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" style="font-size: 1.2rem;">新增执法人员</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addEnforcerForm">
                            <div class="mb-3">
                                <label class="form-label">执法ID <span class="text-danger">*</span></label>
                                <input type="text" id="addOfficeId" class="form-control form-control-sm" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">姓名 <span class="text-danger">*</span></label>
                                <input type="text" id="addName" class="form-control form-control-sm" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">所属部门 <span class="text-danger">*</span></label>
                                <select id="addDepartment" class="form-select form-select-sm" required>
                                    <option value="">请选择部门</option>
                                    <option value="森林公安">森林公安</option>
                                    <option value="环保执法">环保执法</option>
                                    <option value="自然保护区管理局">自然保护区管理局</option>
                                    <option value="野生动物保护站">野生动物保护站</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">执法权限</label>
                                <select id="addAuthority" class="form-select form-select-sm">
                                    <option value="一级">一级（全面执法）</option>
                                    <option value="二级">二级（区域执法）</option>
                                    <option value="三级">三级（辅助执法）</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">联系电话 <span class="text-danger">*</span></label>
                                <input type="text" id="addContact" class="form-control form-control-sm" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">执法设备编号</label>
                                <input type="text" id="addDeviceNo" class="form-control form-control-sm">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary btn-sm" id="saveEnforcerBtn">保存</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 编辑执法人员弹窗 -->
        <div class="modal fade" id="editEnforcerModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" style="font-size: 1.2rem;">编辑执法人员</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editEnforcerForm">
                            <input type="hidden" id="editOfficeId">
                            <div class="mb-3">
                                <label class="form-label">执法ID</label>
                                <input type="text" id="editOfficeIdShow" class="form-control form-control-sm" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">姓名 <span class="text-danger">*</span></label>
                                <input type="text" id="editName" class="form-control form-control-sm" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">所属部门 <span class="text-danger">*</span></label>
                                <select id="editDepartment" class="form-select form-select-sm" required>
                                    <option value="森林公安">森林公安</option>
                                    <option value="环保执法">环保执法</option>
                                    <option value="自然保护区管理局">自然保护区管理局</option>
                                    <option value="野生动物保护站">野生动物保护站</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">执法权限</label>
                                <select id="editAuthority" class="form-select form-select-sm">
                                    <option value="一级">一级（全面执法）</option>
                                    <option value="二级">二级（区域执法）</option>
                                    <option value="三级">三级（辅助执法）</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">联系电话 <span class="text-danger">*</span></label>
                                <input type="text" id="editContact" class="form-control form-control-sm" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">执法设备编号</label>
                                <input type="text" id="editDeviceNo" class="form-control form-control-sm">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary btn-sm" id="updateEnforcerBtn">更新</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // 后端接口基础地址
        const BASE_URL = "http://172.20.10.2:5001/api";
        let currentPage = 1;
        let totalRecords = 0;
        const pageSize = 10;

        // 加载执法人员列表
        function loadLawEnforcers(name = '', department = '', page = 1) {
            currentPage = page;
            document.getElementById('enforcerTableBody').innerHTML = '<tr><td colspan="7" class="text-center">加载中...</td></tr>';

            axios.get(`${BASE_URL}/law-enforcers`, {
                params: {
                    name,
                    department,
                    page,
                    pageSize
                }
            })
            .then(res => {
                if (res.data.code === 200) {
                    const enforcers = res.data.data.records || res.data.data;
                    const total = res.data.data.total || enforcers.length;
                    totalRecords = total;
                    document.getElementById('totalCount').textContent = total;

                    const tableBody = document.getElementById('enforcerTableBody');
                    if (enforcers.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">暂无数据</td></tr>';
                        renderPagination();
                        return;
                    }

                    tableBody.innerHTML = '';
                    enforcers.forEach(enforcer => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${enforcer.office_id}</td>
                            <td>${enforcer.name}</td>
                            <td>${enforcer.department}</td>
                            <td>${enforcer.authority || '-'}</td>
                            <td>${enforcer.contact || '-'}</td>
                            <td>${enforcer.device_no || '-'}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-info detail-btn"
                                            data-office-id="${enforcer.office_id}"
                                            data-name="${enforcer.name}"
                                            data-department="${enforcer.department}"
                                            data-authority="${enforcer.authority || '-'}"
                                            data-contact="${enforcer.contact || '-'}"
                                            data-device-no="${enforcer.device_no || '-'}">详情</button>
                                    <button class="btn btn-warning edit-btn"
                                            data-id="${enforcer.office_id}">编辑</button>
                                    <button class="btn btn-danger delete-btn"
                                            data-id="${enforcer.office_id}">删除</button>
                                </div>
                            </td>
                        `;
                        tableBody.appendChild(tr);
                    });

                    // 绑定按钮事件
                    bindButtonEvents();
                    renderPagination();
                } else {
                    document.getElementById('enforcerTableBody').innerHTML = `<tr><td colspan="7" class="text-center text-danger">${res.data.msg}</td></tr>`;
                }
            })
            .catch(err => {
                console.error('加载执法人员失败：', err);
                document.getElementById('enforcerTableBody').innerHTML = '<tr><td colspan="7" class="text-center text-danger">加载失败，请刷新重试</td></tr>';
            });
        }

        // 渲染分页控件
        function renderPagination() {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            const totalPages = Math.ceil(totalRecords / pageSize);

            if (totalPages <= 1) return;

            // 上一页
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>`;
            prevLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage > 1) {
                    loadLawEnforcers(
                        document.getElementById('nameFilter').value.trim(),
                        document.getElementById('deptFilter').value,
                        currentPage - 1
                    );
                }
            });
            pagination.appendChild(prevLi);

            // 页码
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                li.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (i !== currentPage) {
                        loadLawEnforcers(
                            document.getElementById('nameFilter').value.trim(),
                            document.getElementById('deptFilter').value,
                            i
                        );
                    }
                });
                pagination.appendChild(li);
            }

            // 下一页
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage >= totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>`;
            nextLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage < totalPages) {
                    loadLawEnforcers(
                        document.getElementById('nameFilter').value.trim(),
                        document.getElementById('deptFilter').value,
                        currentPage + 1
                    );
                }
            });
            pagination.appendChild(nextLi);
        }

        // 绑定按钮事件
        function bindButtonEvents() {
            // 详情按钮
            document.querySelectorAll('.detail-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.getElementById('detail-office-id').textContent = btn.getAttribute('data-office-id');
                    document.getElementById('detail-name').textContent = btn.getAttribute('data-name');
                    document.getElementById('detail-department').textContent = btn.getAttribute('data-department');
                    document.getElementById('detail-authority').textContent = btn.getAttribute('data-authority');
                    document.getElementById('detail-contact').textContent = btn.getAttribute('data-contact');
                    document.getElementById('detail-device-no').textContent = btn.getAttribute('data-device-no');

                    const modal = new bootstrap.Modal(document.getElementById('enforcerDetailModal'));
                    modal.show();
                });
            });

            // 编辑按钮
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const officeId = btn.getAttribute('data-id');
                    axios.get(`${BASE_URL}/law-enforcers`)
                        .then(res => {
                            if (res.data.code === 200) {
                                const enforcer = res.data.data.find(e => e.office_id === officeId);
                                if (enforcer) {
                                    document.getElementById('editOfficeId').value = officeId;
                                    document.getElementById('editOfficeIdShow').value = officeId;
                                    document.getElementById('editName').value = enforcer.name;
                                    document.getElementById('editDepartment').value = enforcer.department;
                                    document.getElementById('editAuthority').value = enforcer.authority || '三级';
                                    document.getElementById('editContact').value = enforcer.contact || '';
                                    document.getElementById('editDeviceNo').value = enforcer.device_no || '';

                                    const modal = new bootstrap.Modal(document.getElementById('editEnforcerModal'));
                                    modal.show();
                                }
                            }
                        });
                });
            });

            // 删除按钮
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const officeId = btn.getAttribute('data-id');
                    if (confirm(`确定要删除执法人员 ${officeId} 吗？`)) {
                        axios.delete(`${BASE_URL}/law-enforcers/${officeId}`)
                            .then(res => {
                                if (res.data.code === 200) {
                                    alert('删除成功');
                                    loadLawEnforcers(
                                        document.getElementById('nameFilter').value.trim(),
                                        document.getElementById('deptFilter').value
                                    );
                                } else {
                                    alert('删除失败：' + res.data.msg);
                                }
                            })
                            .catch(err => {
                                alert('删除失败：' + (err.response?.data?.msg || '网络错误'));
                            });
                    }
                });
            });
        }

        // 保存新增执法人员
        document.getElementById('saveEnforcerBtn').addEventListener('click', () => {
            const form = document.getElementById('addEnforcerForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const data = {
                office_id: document.getElementById('addOfficeId').value.trim(),
                name: document.getElementById('addName').value.trim(),
                department: document.getElementById('addDepartment').value,
                authority: document.getElementById('addAuthority').value,
                contact: document.getElementById('addContact').value.trim(),
                device_no: document.getElementById('addDeviceNo').value.trim()
            };

            axios.post(`${BASE_URL}/law-enforcers`, data)
                .then(res => {
                    if (res.data.code === 200) {
                        alert('新增成功');
                        bootstrap.Modal.getInstance(document.getElementById('addEnforcerModal')).hide();
                        loadLawEnforcers();
                        form.reset();
                    } else {
                        alert('新增失败：' + res.data.msg);
                    }
                })
                .catch(err => {
                    alert('新增失败：' + (err.response?.data?.msg || '网络错误'));
                });
        });

        // 更新执法人员信息
        document.getElementById('updateEnforcerBtn').addEventListener('click', () => {
            const form = document.getElementById('editEnforcerForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const officeId = document.getElementById('editOfficeId').value;
            const data = {
                name: document.getElementById('editName').value.trim(),
                department: document.getElementById('editDepartment').value,
                authority: document.getElementById('editAuthority').value,
                contact: document.getElementById('editContact').value.trim(),
                device_no: document.getElementById('editDeviceNo').value.trim()
            };

            axios.put(`${BASE_URL}/law-enforcers/${officeId}`, data)
                .then(res => {
                    if (res.data.code === 200) {
                        alert('更新成功');
                        bootstrap.Modal.getInstance(document.getElementById('editEnforcerModal')).hide();
                        loadLawEnforcers(
                            document.getElementById('nameFilter').value.trim(),
                            document.getElementById('deptFilter').value
                        );
                    } else {
                        alert('更新失败：' + res.data.msg);
                    }
                })
                .catch(err => {
                    alert('更新失败：' + (err.response?.data?.msg || '网络错误'));
                });
        });

        // 搜索按钮事件
        document.getElementById('searchBtn').addEventListener('click', () => {
            loadLawEnforcers(
                document.getElementById('nameFilter').value.trim(),
                document.getElementById('deptFilter').value,
                1
            );
        });

        // 页面加载时初始化
        window.onload = () => {
            // 设置axios默认请求头
            axios.defaults.headers.post['Content-Type'] = 'application/json';
            axios.defaults.headers.put['Content-Type'] = 'application/json';

            loadLawEnforcers();
        };
    </script>
</body>
</html>