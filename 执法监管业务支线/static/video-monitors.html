<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>视频监控点管理 - 智慧林草系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        /* 基础样式优化 */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }

        /* 导航栏优化 */
        .navbar {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .navbar-brand {
            font-weight: 600;
            font-size: 1.25rem;
        }

        .nav-link {
            transition: all 0.3s ease;
            margin: 0 4px;
        }

        .nav-link:hover {
            color: #ffffff !important;
            transform: translateY(-2px);
        }

        /* 卡片样式优化 */
        .card {
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin-bottom: 1.5rem;
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .search-bar {
            margin-bottom: 1rem;
        }

        /* 状态标签样式 */
        .status-badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8rem;
        }

        .status-normal { background-color: #147D4C; color: white; }
        .status-fault { background-color: #dc3545; color: white; }
        .status-maintain { background-color: #ffc107; color: white; }

        /* 按钮样式优化 */
        .btn {
            border-radius: 6px;
            transition: all 0.2s ease;
            padding: 8px 16px;
            font-size: 1rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-primary {
            background-color: #0A5E38;
            border-color: #0A5E38;
        }

        .btn-success {
            background-color: #147D4C;
            border-color: #147D4C;
        }

        .btn-primary:hover, .btn-success:hover {
            opacity: 0.9;
        }

        /* 表格样式优化 */
        .table {
            border-collapse: collapse;
            width: 100%;
            font-size: 0.9rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            background-color: white;
        }

        .table th, .table td {
            vertical-align: middle;
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .table thead {
            background-color: #0A5E38;
            color: white;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .table thead th {
            padding: 14px 16px;
        }

        /* 确保状态和操作列不换行 */
        .table td:nth-last-child(2),
        .table td:last-child,
        .table th:nth-last-child(2),
        .table th:last-child {
            white-space: nowrap;
            min-width: 100px;
        }

        /* 操作按钮样式 */
        .table .btn {
            padding: 4px 12px;
            font-size: 0.85rem;
            margin-right: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .table .btn:last-child {
            margin-right: 0;
        }

        /* 查看按钮样式 */
        .btn-view {
            background-color: #147D4C;
            border-color: #147D4C;
            color: white;
        }

        /* 删除按钮样式 */
        .btn-delete {
            background-color: #dc3545;
            border-color: #dc3545;
            color: white;
        }

        /* 编辑按钮样式 */
        .btn-edit {
            background-color: #ffc107;
            border-color: #ffc107;
            color: #333;
        }

        .table .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* 模态框样式优化 */
        .modal-content {
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
        }

        .modal-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .detail-modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
        </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #0A5E38;">
        <div class="container">
            <a class="navbar-brand" href="index.html">智慧林草系统</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <!--<li class="nav-item"><a class="nav-link" href="index.html">首页</a></li>-->
                    <li class="nav-item"><a class="nav-link" href="illegal-records.html">非法行为记录</a></li>
                    <li class="nav-item"><a class="nav-link" href="law-dispatches.html">执法调度</a></li>
                    <li class="nav-item"><a class="nav-link" href="law-enforcers.html">执法人员管理</a></li>
                    <li class="nav-item"><a class="nav-link active" href="video-monitors.html">视频监控点管理</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>视频监控点管理</h2>
            <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#monitorModal">新增监控点</button>
        </div>

        <!-- 筛选搜索栏 -->
        <div class="card search-bar">
            <div class="card-body p-2">
                <div class="row g-2 align-items-center">
                    <div class="col-md-3">
                        <input type="text" id="monitorIdFilter" class="form-control form-control-sm" placeholder="搜索监控点编号">
                    </div>
                    <div class="col-md-3">
                        <select id="statusFilter" class="form-select form-select-sm">
                            <option value="">所有状态</option>
                            <option value="正常">正常</option>
                            <option value="故障">故障</option>
                            <option value="维护中">维护中</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="text" id="regionFilter" class="form-control form-control-sm" placeholder="搜索部署区域编号">
                    </div>
                    <div class="col-md-3">
                        <button id="searchBtn" class="btn btn-primary btn-sm w-100">查询</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 监控点表格 -->
        <div class="card">
            <div class="card-body p-2">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>监控点编号</th>
                                <th>部署区域编号</th>
                                <th>安装位置（经纬度）</th>
                                <th>监控范围</th>
                                <th>设备状态</th>
                                <th>数据存储周期（天）</th>
                                <th>关联非法行为数</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="monitorTableBody">
                            <tr><td colspan="8" class="text-center">加载中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 监控点详情弹窗 -->
        <div class="modal fade" id="monitorDetailModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" style="font-size: 1.2rem;">监控点详情</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body detail-modal-body" style="font-size: 0.9rem;">
                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label fw-bold">监控点编号</label>
                                    <p id="detail-monitor-id" class="form-control-plaintext"></p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label fw-bold">部署区域编号</label>
                                    <p id="detail-region-id" class="form-control-plaintext"></p>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label class="form-label fw-bold">安装位置（经纬度）</label>
                                    <p id="detail-location" class="form-control-plaintext"></p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label fw-bold">监控范围</label>
                                    <p id="detail-coverage" class="form-control-plaintext"></p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label fw-bold">设备状态</label>
                                    <p id="detail-status" class="form-control-plaintext"></p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label fw-bold">数据存储周期</label>
                                    <p id="detail-storage-period" class="form-control-plaintext"></p>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label class="form-label fw-bold">关联非法行为记录</label>
                                    <p id="detail-illegal-records" class="form-control-plaintext"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">关闭</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 新增/编辑弹窗 -->
        <div class="modal fade" id="monitorModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalTitle">新增监控点</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="monitorForm">
                            <input type="hidden" id="editMonitorId">
                            <div class="mb-3">
                                <label class="form-label">监控点编号 <span class="text-danger">*</span></label>
                                <input type="text" id="monitorId" class="form-control form-control-sm" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">部署区域编号 <span class="text-danger">*</span></label>
                                <input type="text" id="regionId" class="form-control form-control-sm" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">安装位置（经纬度） <span class="text-danger">*</span></label>
                                <input type="text" id="location" class="form-control form-control-sm" placeholder="例如：118.123456,36.654321" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">监控范围</label>
                                <input type="text" id="coverage" class="form-control form-control-sm" placeholder="例如：150米半径">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">设备状态 <span class="text-danger">*</span></label>
                                <select id="status" class="form-select form-select-sm" required>
                                    <option value="正常">正常</option>
                                    <option value="故障">故障</option>
                                    <option value="维护中">维护中</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">数据存储周期（天） <span class="text-danger">*</span></label>
                                <input type="number" id="storagePeriod" class="form-control form-control-sm" min="30" required>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary btn-sm" id="saveMonitorBtn">保存</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 后端接口基础地址
        const BASE_URL = "http://172.20.10.2:5001/api";

        // 获取状 态标签
        function getStatusBadge(status) {
            switch(status) {
                case "正常": return '<span class="status-badge status-normal">正常</span>';
                case "故障": return '<span class="status-badge status-fault">故障</span>';
                case "维护中": return '<span class="status-badge status-maintain">维护中</span>';
                default: return '<span class="status-badge bg-secondary text-white">未知</span>';
            }
        }

        // 加载监控点数据
        function loadVideoMonitors(monitorId = '', status = '', regionId = '') {
            document.getElementById('monitorTableBody').innerHTML = '<tr><td colspan="8" class="text-center">加载中...</td></tr>';

            // 先获取监控点数据
            axios.get(`${BASE_URL}/video-monitors`, {
                params: { monitor_id: monitorId, status, region_id: regionId }
            })
            .then(res => {
                if (res.data.code === 200) {
                    const monitors = res.data.data;

                    // 再获取非法记录数据用于统计关联数
                    axios.get(`${BASE_URL}/illegal-records`, { params: { page: 1, pageSize: 1000 } })
                        .then(illegalRes => {
                            const illegalRecords = illegalRes.data.data?.records || [];
                            const monitorIllegalMap = {};

                            // 构建监控点与非法记录的映射关系
                            illegalRecords.forEach(record => {
                                if (record.monitor_ids) {
                                    record.monitor_ids.split(',').forEach(monitorId => {
                                        if (!monitorIllegalMap[monitorId]) {
                                            monitorIllegalMap[monitorId] = [];
                                        }
                                        monitorIllegalMap[monitorId].push(record.record_id);
                                    });
                                }
                            });

                            // 渲染表格
                            const tableBody = document.getElementById('monitorTableBody');
                            if (monitors.length === 0) {
                                tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">暂无符合条件的监控点</td></tr>';
                                return;
                            }

                            tableBody.innerHTML = '';
                            monitors.forEach(monitor => {
                                const relatedIllegalCount = monitorIllegalMap[monitor.monitor_id]?.length || 0;
                                const tr = document.createElement('tr');
                                tr.innerHTML = `
                                    <td>${monitor.monitor_id}</td>
                                    <td>${monitor.region_id}</td>
                                    <td>${monitor.location}</td>
                                    <td>${monitor.coverage || '<span class="text-muted">未填写</span>'}</td>
                                    <td>${getStatusBadge(monitor.status)}</td>
                                    <td>${monitor.storage_period}</td>
                                    <td>${relatedIllegalCount}</td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-info detail-btn"
                                                    data-monitor-id="${monitor.monitor_id}"
                                                    data-region-id="${monitor.region_id}"
                                                    data-location="${monitor.location}"
                                                    data-coverage="${monitor.coverage || '未填写'}"
                                                    data-status="${monitor.status}"
                                                    data-storage-period="${monitor.storage_period}"
                                                    data-illegal-records="${monitorIllegalMap[monitor.monitor_id]?.join('、') || '无'}">详情</button>
                                            <button class="btn btn-warning edit-monitor-btn"
                                                    data-id="${monitor.monitor_id}">编辑</button>
                                            <button class="btn btn-danger delete-monitor-btn"
                                                    data-id="${monitor.monitor_id}">删除</button>
                                        </div>
                                    </td>
                                `;
                                tableBody.appendChild(tr);
                            });

                            // 绑定按钮事件
                            bindButtonEvents();
                        })
                        .catch(err => {
                            console.error('非法记录加载失败：', err);
                            // 即使非法记录加载失败也展示监控点数据
                            renderMonitorsWithoutIllegal(monitors);
                        });
                } else {
                    alert('监控点数据加载失败：' + res.data.msg);
                    document.getElementById('monitorTableBody').innerHTML = '<tr><td colspan="8" class="text-center text-danger">加载失败，请重试</td></tr>';
                }
            })
            .catch(err => {
                console.error('监控点请求失败：', err);
                const errorMsg = err.response?.data?.msg || '网络错误，请检查后端服务';
                document.getElementById('monitorTableBody').innerHTML = `<tr><td colspan="8" class="text-center text-danger">${errorMsg}</td></tr>`;
            });
        }

        // 没有非法记录数据时渲染监控点
        function renderMonitorsWithoutIllegal(monitors) {
            const tableBody = document.getElementById('monitorTableBody');
            tableBody.innerHTML = '';
            monitors.forEach(monitor => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${monitor.monitor_id}</td>
                    <td>${monitor.region_id}</td>
                    <td>${monitor.location}</td>
                    <td>${monitor.coverage || '<span class="text-muted">未填写</span>'}</td>
                    <td>${getStatusBadge(monitor.status)}</td>
                    <td>${monitor.storage_period}</td>
                    <td><span class="text-muted">未知</span></td>
                    <td>
                        <button class="btn btn-sm btn-warning edit-monitor-btn"
                                data-id="${monitor.monitor_id}">编辑</button>
                        <button class="btn btn-sm btn-danger delete-monitor-btn"
                                data-id="${monitor.monitor_id}">删除</button>
                        <button class="btn btn-sm btn-info detail-btn"
                                data-monitor-id="${monitor.monitor_id}"
                                data-region-id="${monitor.region_id}"
                                data-location="${monitor.location}"
                                data-coverage="${monitor.coverage || '未填写'}"
                                data-status="${monitor.status}"
                                data-storage-period="${monitor.storage_period}"
                                data-illegal-records="加载失败">
                            详情
                        </button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
            bindButtonEvents();
        }

        // 绑定按钮事件
        function bindButtonEvents() {
            // 编辑按钮
            document.querySelectorAll('.edit-monitor-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const monitorId = btn.getAttribute('data-id');
                    axios.get(`${BASE_URL}/video-monitors`)
                        .then(res => {
                            const monitor = res.data.data.find(m => m.monitor_id === monitorId);
                            if (monitor) {
                                document.getElementById('modalTitle').textContent = '编辑监控点';
                                document.getElementById('editMonitorId').value = monitorId;
                                document.getElementById('monitorId').value = monitor.monitor_id;
                                document.getElementById('monitorId').disabled = true;
                                document.getElementById('regionId').value = monitor.region_id;
                                document.getElementById('location').value = monitor.location;
                                document.getElementById('coverage').value = monitor.coverage || '';
                                document.getElementById('status').value = monitor.status;
                                document.getElementById('storagePeriod').value = monitor.storage_period;

                                new bootstrap.Modal(document.getElementById('monitorModal')).show();
                            }
                        });
                });
            });

            // 删除按钮
            document.querySelectorAll('.delete-monitor-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (confirm('确定要删除该监控点吗？')) {
                        const monitorId = btn.getAttribute('data-id');
                        axios.delete(`${BASE_URL}/video-monitors/${monitorId}`)
                            .then(res => {
                                if (res.data.code === 200) {
                                    alert('删除成功');
                                    loadVideoMonitors(
                                        document.getElementById('monitorIdFilter').value.trim(),
                                        document.getElementById('statusFilter').value,
                                        document.getElementById('regionFilter').value.trim()
                                    );
                                } else {
                                    alert('删除失败：' + res.data.msg);
                                }
                            })
                            .catch(err => {
                                alert('删除失败：' + (err.response?.data?.msg || '网络错误'));
                            });
                    }
                });
            });

            // 详情按钮
            document.querySelectorAll('.detail-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.getElementById('detail-monitor-id').textContent = btn.getAttribute('data-monitor-id');
                    document.getElementById('detail-region-id').textContent = btn.getAttribute('data-region-id');
                    document.getElementById('detail-location').textContent = btn.getAttribute('data-location');
                    document.getElementById('detail-coverage').textContent = btn.getAttribute('data-coverage');
                    document.getElementById('detail-status').textContent = btn.getAttribute('data-status');
                    document.getElementById('detail-storage-period').textContent = btn.getAttribute('data-storage-period') + ' 天';
                    document.getElementById('detail-illegal-records').textContent = btn.getAttribute('data-illegal-records');

                    const modal = new bootstrap.Modal(document.getElementById('monitorDetailModal'));
                    modal.show();
                });
            });
        }

        // 保存监控点
        document.getElementById('saveMonitorBtn').addEventListener('click', () => {
            const form = document.getElementById('monitorForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const editId = document.getElementById('editMonitorId').value;
            const data = {
                monitor_id: document.getElementById('monitorId').value,
                region_id: document.getElementById('regionId').value,
                location: document.getElementById('location').value,
                coverage: document.getElementById('coverage').value,
                status: document.getElementById('status').value,
                storage_period: parseInt(document.getElementById('storagePeriod').value)
            };

            // 新增操作
            if (!editId) {
                axios.post(`${BASE_URL}/video-monitors`, data)
                    .then(res => {
                        if (res.data.code === 200) {
                            alert('新增成功');
                            bootstrap.Modal.getInstance(document.getElementById('monitorModal')).hide();
                            loadVideoMonitors();
                            form.reset();
                        } else {
                            alert('新增失败：' + res.data.msg);
                        }
                    })
                    .catch(err => {
                        alert('新增失败：' + (err.response?.data?.msg || '网络错误'));
                    });
            }
            // 编辑操作
            else {
                axios.put(`${BASE_URL}/video-monitors/${editId}`, data)
                    .then(res => {
                        if (res.data.code === 200) {
                            alert('更新成功');
                            bootstrap.Modal.getInstance(document.getElementById('monitorModal')).hide();
                            loadVideoMonitors(
                                document.getElementById('monitorIdFilter').value.trim(),
                                document.getElementById('statusFilter').value,
                                document.getElementById('regionFilter').value.trim()
                            );
                        } else {
                            alert('更新失败：' + res.data.msg);
                        }
                    })
                    .catch(err => {
                        alert('更新失败：' + (err.response?.data?.msg || '网络错误'));
                    });
            }
        });

        // 搜索按钮事件
        document.getElementById('searchBtn').addEventListener('click', () => {
            const monitorId = document.getElementById('monitorIdFilter').value.trim();
            const status = document.getElementById('statusFilter').value;
            const regionId = document.getElementById('regionFilter').value.trim();
            loadVideoMonitors(monitorId, status, regionId);
        });

        // 页面加载初始化
        window.onload = () => {
            loadVideoMonitors();
        };
    </script>
</body>
</html>