<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>非法行为记录管理 - 智慧林草系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* 基础样式优化 */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }

        /* 导航栏优化 */
        .navbar {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .navbar-brand {
            font-weight: 600;
            font-size: 1.25rem;
        }

        .nav-link {
            transition: all 0.3s ease;
            margin: 0 4px;
        }

        .nav-link:hover {
            color: #ffffff !important;
            transform: translateY(-2px);
        }

        /* 卡片样式优化 */
        .card {
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        /* 按钮样式优化 */
        .btn {
            border-radius: 6px;
            transition: all 0.2s ease;
            padding: 8px 16px;
            font-size: 1rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-success {
            background-color: #147D4C;
            border-color: #147D4C;
        }

        .btn-primary {
            background-color: #0A5E38;
            border-color: #0A5E38;
        }

        .btn-primary:hover, .btn-success:hover {
            opacity: 0.9;
        }

        /* 表格样式优化 */
        .table {
            border-collapse: collapse;
            width: 100%;
            font-size: 0.9rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            background-color: white;
        }

        .table th, .table td {
            vertical-align: middle;
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .table thead {
            background-color: #0A5E38;
            color: white;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .table-hover tbody tr:hover {
            background-color: #f0f9f0;
        }

        /* 确保状态和操作列不换行 */
        .table td:nth-last-child(2),
        .table td:last-child,
        .table th:nth-last-child(2),
        .table th:last-child {
            white-space: nowrap;
            min-width: 100px;
        }

        /* 操作按钮样式 */
        .table .btn {
            padding: 4px 12px;
            font-size: 0.85rem;
            margin-right: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .table .btn:last-child {
            margin-right: 0;
        }

        /* 查看按钮样式 */
        .btn-view {
            background-color: #147D4C;
            border-color: #147D4C;
            color: white;
        }

        /* 删除按钮样式 */
        .btn-delete {
            background-color: #dc3545;
            border-color: #dc3545;
            color: white;
        }

        /* 编辑按钮样式 */
        .btn-edit {
            background-color: #ffc107;
            border-color: #ffc107;
            color: #333;
        }

        .table .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* 模态框样式优化 */
        .modal-content {
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
        }

        .modal-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        /* 分页样式优化 */
        .pagination {
            margin-top: 1rem;
            justify-content: center;
        }

        .pagination .page-link {
            color: #0A5E38;
            border-radius: 6px;
            margin: 0 3px;
        }

        .pagination .page-item.active .page-link {
            background-color: #0A5E38;
            border-color: #0A5E38;
        }

        /* 筛选栏样式优化 */
        .card-body.p-2 {
            padding: 1rem !important;
        }

        .form-select, .form-control {
            border-radius: 6px;
            transition: border-color 0.2s ease;
        }

        .form-select:focus, .form-control:focus {
            border-color: #147D4C;
            box-shadow: 0 0 0 3px rgba(0, 100, 0, 0.1);
        }

        /* 状态标签样式优化 */
        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-pending {
            background-color: #ffc107;
            color: #212529;
        }

        .status-handling {
            background-color: #17a2b8;
            color: white;
        }

        .status-closed {
            background-color: #147D4C;
            color: white;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #0A5E38;">
        <div class="container">
            <a class="navbar-brand" href="#">智慧林草系统</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <!-- 删除了首页选项 -->
                    <li class="nav-item"><a class="nav-link active" href="illegal-records.html">非法行为记录</a></li>
                    <li class="nav-item"><a class="nav-link" href="law-dispatches.html">执法调度</a></li>
                    <li class="nav-item"><a class="nav-link" href="law-enforcers.html">执法人员管理</a></li>
                    <li class="nav-item"><a class="nav-link" href="video-monitors.html">视频监控点管理</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-3">
        <!-- 页面标题 -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>非法行为记录管理</h2>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addRecordModal">新增记录</button>
        </div>

        <!-- 筛选栏 -->
        <div class="card mb-3">
            <div class="card-body p-2">
                <div class="row g-2 align-items-center">
                    <div class="col-md-2">
                        <select id="statusFilter" class="form-select form-select-sm">
                            <option value="">全部状态</option>
                            <option value="未处理">未处理</option>
                            <option value="处理中">处理中</option>
                            <option value="已结案">已结案</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select id="behaviorTypeFilter" class="form-select form-select-sm">
                            <option value="">全部行为类型</option>
                            <option value="非法进入">非法进入</option>
                            <option value="盗猎">盗猎</option>
                            <option value="破坏植被">破坏植被</option>
                            <option value="非法露营">非法露营</option>
                            <option value="乱扔垃圾">乱扔垃圾</option>
                        </select>
                    </div>
                    <div class="col-md-1">
                        <button id="searchBtn" class="btn btn-primary btn-sm w-100">查询</button>
                    </div>
                    <div class="col-md-7 text-end">
                        <span class="text-muted">共 <strong id="totalCount">0</strong> 条记录</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 数据表格 -->
        <div class="card">
            <div class="card-body p-2">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover table-sm">
                        <thead>
                            <tr>
                                <th>记录编号</th>
                                <th>行为类型</th>
                                <th>发生区域</th>
                                <th>发生时间</th>
                                <th>处理状态</th>
                                <th>关联监控点</th>
                                <th>证据</th>
                                <th>处罚依据</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="recordTableBody">
                            <tr><td colspan="9" class="text-center">加载中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 分页控件 -->
        <div class="pagination-container">
            <ul class="pagination" id="pagination">
                <!-- 分页内容将通过JS动态生成 -->
            </ul>
        </div>

        <!-- 处理记录弹窗 -->
        <div class="modal fade" id="handleRecordModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" style="font-size: 1.2rem;">处理非法行为记录</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="handleRecordForm">
                            <div class="row mb-2">
                                <label class="col-sm-2 col-form-label" style="font-size: 0.9rem;">记录编号</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control form-control-sm" id="recordIdShow" readonly>
                                    <input type="hidden" id="recordId">
                                </div>
                            </div>
                            <div class="row mb-2">
                                <label class="col-sm-2 col-form-label" style="font-size: 0.9rem;">行为类型</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control form-control-sm" id="behaviorType" readonly>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <label class="col-sm-2 col-form-label" style="font-size: 0.9rem;">发生区域</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control form-control-sm" id="regionName" readonly>
                                </div>
                            </div>

                            <div class="row mb-2">
                                <label class="col-sm-2 col-form-label" style="font-size: 0.9rem;">处理状态 <span class="text-danger">*</span></label>
                                <div class="col-sm-10">
                                    <select class="form-select form-select-sm" name="status" required>
                                        <option value="处理中">处理中</option>
                                        <option value="已结案">已结案</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row mb-2">
                                <label class="col-sm-2 col-form-label" style="font-size: 0.9rem;">执法人员 <span class="text-danger">*</span></label>
                                <div class="col-sm-10">
                                    <select class="form-select form-select-sm" name="officer_id" id="officerSelect" required>
                                        <option value="">加载中...</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row mb-2">
                                <label class="col-sm-2 col-form-label" style="font-size: 0.9rem;">处理结果 <span class="text-danger">*</span></label>
                                <div class="col-sm-10">
                                    <textarea class="form-control form-control-sm" name="result" rows="2" required placeholder="如：警告教育、罚款500元"></textarea>
                                </div>
                            </div>

                            <div class="row mb-2">
                                <label class="col-sm-2 col-form-label" style="font-size: 0.9rem;">处罚依据</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control form-control-sm" name="basis" placeholder="如：《国家公园管理条例》第二十三条">
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary btn-sm" id="submitHandleBtn">提交处理</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 新增记录弹窗 -->
        <div class="modal fade" id="addRecordModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" style="font-size: 1.2rem;">新增非法行为记录</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addRecordForm">
                            <div class="mb-3">
                                <label class="form-label">记录编号 <span class="text-danger">*</span></label>
                                <input type="text" id="addRecordId" class="form-control form-control-sm" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">行为类型 <span class="text-danger">*</span></label>
                                <select id="addBehaviorType" class="form-select form-select-sm" required>
                                    <option value="">请选择行为类型</option>
                                    <option value="非法进入">非法进入</option>
                                    <option value="盗猎">盗猎</option>
                                    <option value="破坏植被">破坏植被</option>
                                    <option value="非法露营">非法露营</option>
                                    <option value="乱扔垃圾">乱扔垃圾</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">区域ID <span class="text-danger">*</span></label>
                                <input type="text" id="addRegionId" class="form-control form-control-sm" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">发生时间 <span class="text-danger">*</span></label>
                                <input type="datetime-local" id="addOccurrenceTime" class="form-control form-control-sm" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">证据路径</label>
                                <input type="text" id="addEvidencePath" class="form-control form-control-sm" placeholder="例如：/evidence/2023/05/record123.mp4">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary btn-sm" id="saveRecordBtn">保存</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 编辑记录弹窗 -->
        <div class="modal fade" id="editRecordModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" style="font-size: 1.2rem;">编辑非法行为记录</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editRecordForm">
                            <input type="hidden" id="editRecordId">
                            <div class="mb-3">
                                <label class="form-label">记录编号</label>
                                <input type="text" id="editRecordIdShow" class="form-control form-control-sm" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">行为类型 <span class="text-danger">*</span></label>
                                <select id="editBehaviorType" class="form-select form-select-sm" required>
                                    <option value="非法进入">非法进入</option>
                                    <option value="盗猎">盗猎</option>
                                    <option value="破坏植被">破坏植被</option>
                                    <option value="非法露营">非法露营</option>
                                    <option value="乱扔垃圾">乱扔垃圾</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">区域ID <span class="text-danger">*</span></label>
                                <input type="text" id="editRegionId" class="form-control form-control-sm" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">发生时间 <span class="text-danger">*</span></label>
                                <input type="datetime-local" id="editOccurrenceTime" class="form-control form-control-sm" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">证据路径</label>
                                <input type="text" id="editEvidencePath" class="form-control form-control-sm" placeholder="例如：/evidence/2023/05/record123.mp4">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary btn-sm" id="updateRecordBtn">更新</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // 后端接口基础地址
        const BASE_URL = "http://172.20.10.2:5001/api";
        let currentPage = 1;
        let totalRecords = 0;
        const pageSize = 10;

        // 处理时间格式化
        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '';
            const date = new Date(dateTimeStr);
            if (isNaN(date.getTime())) return dateTimeStr;

            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // 处理状态标签
        function getStatusBadge(status) {
            switch(status) {
                case "未处理": return '<span class="status-badge status-pending">未处理</span>';
                case "处理中": return '<span class="status-badge status-handling">处理中</span>';
                case "已结案": return '<span class="status-badge status-closed">已结案</span>';
                default: return '<span class="status-badge bg-secondary">未知</span>';
            }
        }

        // 影像证据显示
        function formatEvidence(evidencePath) {
            if (!evidencePath) return '无';
            return `<a href="${evidencePath}" class="evidence-link" target="_blank">查看证据</a>`;
        }

        // 加载非法行为记录（含分页）
        function loadIllegalRecords(status = '', behaviorType = '', page = 1) {
            document.getElementById('recordTableBody').innerHTML = '<tr><td colspan="9" class="text-center">加载中...</td></tr>';

            axios.get(`${BASE_URL}/illegal-records`, {
                params: { status, behavior_type: behaviorType, page, pageSize }
            })
            .then(res => {
                if (res.data.code === 200) {
                    const { records, total, page: currentPageRes } = res.data.data;
                    totalRecords = total;
                    currentPage = currentPageRes;
                    document.getElementById('totalCount').textContent = total;

                    // 渲染表格
                    const tableBody = document.getElementById('recordTableBody');
                    if (records.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">暂无数据</td></tr>';
                        renderPagination();
                        return;
                    }

                    tableBody.innerHTML = '';
                    records.forEach(record => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${record.record_id}</td>
                            <td>${record.behavior_type || '未知'}</td>
                            <td>${record.region_id || '未知'}</td>
                            <td>${formatDateTime(record.occurrence_time)}</td>
                            <td>${getStatusBadge(record.status || '未处理')}</td>
                            <td>${record.monitor_id || '无'}</td>
                            <td>${formatEvidence(record.evidence_path)}</td>
                            <td>${record.punishment_basis || '-'}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    ${record.status === '未处理' ?
                                        `<button class="btn btn-primary handle-record-btn"
                                            data-id="${record.record_id}"
                                            data-type="${record.behavior_type}"
                                            data-region="${record.region_id}">处理</button>` : ''
                                    }
                                    <button class="btn btn-warning edit-record-btn"
                                        data-id="${record.record_id}">编辑</button>
                                    <button class="btn btn-danger delete-record-btn"
                                        data-id="${record.record_id}">删除</button>
                                </div>
                            </td>
                        `;
                        tableBody.appendChild(tr);
                    });

                    // 绑定按钮事件
                    bindButtonEvents();
                    renderPagination();
                } else {
                    document.getElementById('recordTableBody').innerHTML = `<tr><td colspan="9" class="text-center text-danger">${res.data.msg}</td></tr>`;
                }
            })
            .catch(err => {
                console.error('加载非法行为记录失败：', err);
                document.getElementById('recordTableBody').innerHTML = '<tr><td colspan="9" class="text-center text-danger">加载失败，请刷新重试</td></tr>';
            });
        }

        // 加载执法人员列表（用于处理记录时选择）
        function loadLawEnforcers() {
            axios.get(`${BASE_URL}/law-enforcers`)
                .then(res => {
                    if (res.data.code === 200) {
                        const enforcers = res.data.data;
                        const select = document.getElementById('officerSelect');
                        select.innerHTML = '';

                        enforcers.forEach(enforcer => {
                            const option = document.createElement('option');
                            option.value = enforcer.office_id;
                            option.textContent = `${enforcer.name} (${enforcer.department})`;
                            select.appendChild(option);
                        });
                    } else {
                        document.getElementById('officerSelect').innerHTML = '<option value="">加载失败</option>';
                    }
                })
                .catch(err => {
                    console.error('加载执法人员失败：', err);
                    document.getElementById('officerSelect').innerHTML = '<option value="">加载失败</option>';
                });
        }

        // 绑定表格按钮事件
        function bindButtonEvents() {
            // 处理按钮
            document.querySelectorAll('.handle-record-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const recordId = btn.getAttribute('data-id');
                    const behaviorType = btn.getAttribute('data-type');
                    const regionName = btn.getAttribute('data-region');

                    document.getElementById('recordId').value = recordId;
                    document.getElementById('recordIdShow').value = recordId;
                    document.getElementById('behaviorType').value = behaviorType;
                    document.getElementById('regionName').value = regionName;

                    loadLawEnforcers(); // 加载执法人员下拉
                    const modal = new bootstrap.Modal(document.getElementById('handleRecordModal'));
                    modal.show();
                });
            });

            // 编辑按钮
            document.querySelectorAll('.edit-record-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const recordId = btn.getAttribute('data-id');
                    axios.get(`${BASE_URL}/illegal-records`, { params: { page: 1, pageSize: 1000 } })
                        .then(res => {
                            const record = res.data.data.records.find(r => r.record_id === recordId);
                            if (record) {
                                document.getElementById('editRecordId').value = recordId;
                                document.getElementById('editRecordIdShow').value = recordId;
                                document.getElementById('editBehaviorType').value = record.behavior_type;
                                document.getElementById('editRegionId').value = record.region_id;

                                // 格式化时间为datetime-local格式
                                const date = new Date(record.occurrence_time);
                                const formattedTime = date.toISOString().slice(0, 16);
                                document.getElementById('editOccurrenceTime').value = formattedTime;

                                document.getElementById('editEvidencePath').value = record.evidence_path || '';

                                const modal = new bootstrap.Modal(document.getElementById('editRecordModal'));
                                modal.show();
                            }
                        });
                });
            });

            // 删除按钮
            document.querySelectorAll('.delete-record-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (confirm('确定要删除该记录吗？')) {
                        const recordId = btn.getAttribute('data-id');
                        axios.delete(`${BASE_URL}/illegal-records/${recordId}`)
                            .then(res => {
                                if (res.data.code === 200) {
                                    alert('删除成功');
                                    const status = document.getElementById('statusFilter').value;
                                    const behaviorType = document.getElementById('behaviorTypeFilter').value;
                                    loadIllegalRecords(status, behaviorType, currentPage);
                                } else {
                                    alert('删除失败：' + res.data.msg);
                                }
                            })
                            .catch(err => {
                                alert('删除失败：' + (err.response?.data?.msg || '网络错误'));
                            });
                    }
                });
            });
        }

        // 渲染分页控件
        function renderPagination() {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            const totalPages = Math.ceil(totalRecords / pageSize);

            // 上一页
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>`;
            prevLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage > 1) {
                    const status = document.getElementById('statusFilter').value;
                    const behaviorType = document.getElementById('behaviorTypeFilter').value;
                    loadIllegalRecords(status, behaviorType, currentPage - 1);
                }
            });
            pagination.appendChild(prevLi);

            // 页码
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                li.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (i !== currentPage) {
                        const status = document.getElementById('statusFilter').value;
                        const behaviorType = document.getElementById('behaviorTypeFilter').value;
                        loadIllegalRecords(status, behaviorType, i);
                    }
                });
                pagination.appendChild(li);
            }

            // 下一页
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage >= totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>`;
            nextLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage < totalPages) {
                    const status = document.getElementById('statusFilter').value;
                    const behaviorType = document.getElementById('behaviorTypeFilter').value;
                    loadIllegalRecords(status, behaviorType, currentPage + 1);
                }
            });
            pagination.appendChild(nextLi);
        }

        // 提交处理结果
        document.getElementById('submitHandleBtn').addEventListener('click', () => {
            const form = document.getElementById('handleRecordForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const recordId = document.getElementById('recordId').value;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            axios.put(`${BASE_URL}/illegal-records/${recordId}/handle`, data)
                .then(res => {
                    if (res.data.code === 200) {
                        alert('处理成功');
                        bootstrap.Modal.getInstance(document.getElementById('handleRecordModal')).hide();
                        const status = document.getElementById('statusFilter').value;
                        const behaviorType = document.getElementById('behaviorTypeFilter').value;
                        loadIllegalRecords(status, behaviorType, currentPage);
                    } else {
                        alert('处理失败：' + res.data.msg);
                    }
                })
                .catch(err => {
                    alert('处理失败：' + (err.response?.data?.msg || '网络错误'));
                });
        });

        // 保存新增记录
        document.getElementById('saveRecordBtn').addEventListener('click', () => {
            const form = document.getElementById('addRecordForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const data = {
                record_id: document.getElementById('addRecordId').value,
                behavior_type: document.getElementById('addBehaviorType').value,
                region_id: document.getElementById('addRegionId').value,
                occurrence_time: document.getElementById('addOccurrenceTime').value,
                evidence_path: document.getElementById('addEvidencePath').value
            };

            axios.post(`${BASE_URL}/illegal-records`, data)
                .then(res => {
                    if (res.data.code === 200) {
                        alert('新增成功');
                        bootstrap.Modal.getInstance(document.getElementById('addRecordModal')).hide();
                        loadIllegalRecords();
                        form.reset();
                    } else {
                        alert('新增失败：' + res.data.msg);
                    }
                })
                .catch(err => {
                    alert('新增失败：' + (err.response?.data?.msg || '网络错误'));
                });
        });

        // 更新记录
        document.getElementById('updateRecordBtn').addEventListener('click', () => {
            const form = document.getElementById('editRecordForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const recordId = document.getElementById('editRecordId').value;
            const data = {
                behavior_type: document.getElementById('editBehaviorType').value,
                region_id: document.getElementById('editRegionId').value,
                occurrence_time: document.getElementById('editOccurrenceTime').value,
                evidence_path: document.getElementById('editEvidencePath').value
            };

            axios.put(`${BASE_URL}/illegal-records/${recordId}`, data)
                .then(res => {
                    if (res.data.code === 200) {
                        alert('更新成功');
                        bootstrap.Modal.getInstance(document.getElementById('editRecordModal')).hide();
                        const status = document.getElementById('statusFilter').value;
                        const behaviorType = document.getElementById('behaviorTypeFilter').value;
                        loadIllegalRecords(status, behaviorType, currentPage);
                    } else {
                        alert('更新失败：' + res.data.msg);
                    }
                })
                .catch(err => {
                    alert('更新失败：' + (err.response?.data?.msg || '网络错误'));
                });
        });

        // 搜索按钮事件
        document.getElementById('searchBtn').addEventListener('click', () => {
            const status = document.getElementById('statusFilter').value;
            const behaviorType = document.getElementById('behaviorTypeFilter').value;
            loadIllegalRecords(status, behaviorType, 1); // 搜索后回到第一页
        });

        // 页面加载时初始化
        window.onload = () => {
            // 设置axios默认请求头
            axios.defaults.headers.post['Content-Type'] = 'application/json';
            axios.defaults.headers.put['Content-Type'] = 'application/json';

            loadIllegalRecords();
        };
    </script>
</body>
</html>