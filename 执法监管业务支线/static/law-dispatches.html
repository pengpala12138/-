<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>执法调度管理 - 智慧林草系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* 基础样式优化 */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }

        /* 导航栏优化 */
        .navbar {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .navbar-brand {
            font-weight: 600;
            font-size: 1.25rem;
        }

        .nav-link {
            transition: all 0.3s ease;
            margin: 0 4px;
        }

        .nav-link:hover {
            color: #ffffff !important;
            transform: translateY(-2px);
        }

        /* 卡片样式优化 */
        .card {
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        /* 按钮样式优化 */
        .btn {
            border-radius: 6px;
            transition: all 0.2s ease;
            padding: 8px 16px;
            font-size: 1rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-success {
            background-color: #147D4C;
            border-color: #147D4C;
        }

        .btn-primary {
            background-color: #0A5E38;
            border-color: #0A5E38;
        }

        .btn-primary:hover, .btn-success:hover {
            opacity: 0.9;
        }

        /* 表格样式优化 */
        .table {
            border-collapse: collapse;
            width: 100%;
            font-size: 0.9rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            background-color: white;
        }

        .table th, .table td {
            vertical-align: middle;
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .table thead {
            background-color: #0A5E38;
            color: white;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .table thead th {
            padding: 14px 16px;
        }

        /* 确保状态和操作列不换行 */
        .table td:nth-last-child(2),
        .table td:last-child,
        .table th:nth-last-child(2),
        .table th:last-child {
            white-space: nowrap;
            min-width: 100px;
        }

        /* 状态标签样式 */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            color: white;
        }

        /* 操作按钮样式 */
        .table .btn {
            padding: 4px 12px;
            font-size: 0.85rem;
            margin-right: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .table .btn:last-child {
            margin-right: 0;
        }

        /* 查看按钮样式 */
        .btn-view {
            background-color: #147D4C;
            border-color: #147D4C;
            color: white;
        }

        /* 删除按钮样式 */
        .btn-delete {
            background-color: #dc3545;
            border-color: #dc3545;
            color: white;
        }

        /* 编辑按钮样式 */
        .btn-edit {
            background-color: #ffc107;
            border-color: #ffc107;
            color: #333;
        }

        .table .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* 模态框样式优化 */
        .modal-content {
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
        }

        .modal-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        /* 分页样式优化 */
        .pagination {
            margin-top: 1rem;
            justify-content: center;
        }

        .pagination .page-link {
            color: #0d6efd;
            border-radius: 6px;
            margin: 0 3px;
        }

        .pagination .page-item.active .page-link {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }

        /* 筛选栏样式优化 */
        .card-body.p-2 {
            padding: 1rem !important;
        }

        .form-select, .form-control {
            border-radius: 6px;
            transition: border-color 0.2s ease;
        }

        .form-select:focus, .form-control:focus {
            border-color: #147D4C;
            box-shadow: 0 0 0 3px rgba(0, 100, 0, 0.1);
        }

        /* 状态标签样式优化 */
        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-pending {
            background-color: #ffc107;
            color: #212529;
        }

        .status-dispatched {
            background-color: #17a2b8;
            color: white;
        }

        .status-completed {
            background-color: #28a745;
            color: white;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #0A5E38;">
        <div class="container">
            <a class="navbar-brand" href="#">智慧林草系统</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <!-- 删除了首页选项 -->
                    <li class="nav-item"><a class="nav-link" href="illegal-records.html">非法行为记录</a></li>
                    <li class="nav-item"><a class="nav-link active" href="law-dispatches.html">执法调度</a></li>
                    <li class="nav-item"><a class="nav-link" href="law-enforcers.html">执法人员管理</a></li>
                    <li class="nav-item"><a class="nav-link" href="video-monitors.html">视频监控点管理</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-3">
        <!-- 页面标题 -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>执法调度管理</h2>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addDispatchModal">新增调度</button>
        </div>

        <!-- 筛选栏 -->
        <div class="card mb-3">
            <div class="card-body p-2">
                <div class="row g-2 align-items-center">
                    <div class="col-md-3">
                        <select id="statusFilter" class="form-select form-select-sm">
                            <option value="">全部状态</option>
                            <option value="待响应">待响应</option>
                            <option value="已派单">已派单</option>
                            <option value="已完成">已完成</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="text" id="officerNameFilter" class="form-control form-control-sm" placeholder="输入执法人员姓名搜索">
                    </div>
                    <div class="col-md-1">
                        <button id="searchBtn" class="btn btn-primary btn-sm w-100">查询</button>
                    </div>
                    <div class="col-md-5 text-end">
                        <span class="text-muted">共 <strong id="totalCount">0</strong> 条记录</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 数据表格 -->
        <div class="card">
            <div class="card-body p-2">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>调度编号</th>
                                <th>执法人员</th>
                                <th>所属部门</th>
                                <th>行为类型</th>
                                <th>非法记录ID</th>
                                <th>调度时间</th>
                                <th>完成时间</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="dispatchTableBody">
                            <tr><td colspan="9" class="text-center">加载中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 分页控件 -->
        <div class="pagination-container">
            <ul class="pagination" id="pagination">
                <!-- 分页内容将通过JS动态生成 -->
            </ul>
        </div>

        <!-- 新增调度弹窗 -->
        <div class="modal fade" id="addDispatchModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" style="font-size: 1.2rem;">新增执法调度</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addDispatchForm">
                            <div class="mb-3">
                                <label class="form-label">调度编号 <span class="text-danger">*</span></label>
                                <input type="text" id="addDispatchId" class="form-control form-control-sm" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">非法行为记录ID <span class="text-danger">*</span></label>
                                <input type="text" id="addIllegalRecordId" class="form-control form-control-sm" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">执法人员ID <span class="text-danger">*</span></label>
                                <select id="addOfficerId" class="form-select form-select-sm" required>
                                    <option value="">加载中...</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary btn-sm" id="saveDispatchBtn">保存</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 更新状态弹窗 -->
        <div class="modal fade" id="updateDispatchModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" style="font-size: 1.2rem;">更新调度状态</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="updateDispatchForm">
                            <input type="hidden" id="updateDispatchId">
                            <div class="mb-3">
                                <label class="form-label">调度编号</label>
                                <input type="text" id="updateDispatchIdShow" class="form-control form-control-sm" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">当前状态</label>
                                <input type="text" id="currentStatus" class="form-control form-control-sm" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">新状态 <span class="text-danger">*</span></label>
                                <select id="newStatus" class="form-select form-select-sm" required>
                                    <option value="待响应">待响应</option>
                                    <option value="已派单">已派单</option>
                                    <option value="已完成">已完成</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary btn-sm" id="submitUpdateBtn">提交更新</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // 后端接口基础地址
        const BASE_URL = "http://http://172.20.10.2:5001/api";
        let currentPage = 1;
        const pageSize = 10;

        //  时间格式化函数
        function formatTime(gmtTime) {
            if (!gmtTime) return "";
            // 处理MySQL时间字符串（替换T/空格，兼容不同格式）
            const timeStr = gmtTime.replace('T', ' ').split('.')[0];
            const date = new Date(timeStr);
            // 兼容无效时间
            if (isNaN(date.getTime())) return "";
            return date.toLocaleString('zh-CN', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
        }

        // 处理状态标签
        function getStatusBadge(status) {
            switch(status) {
                case "待响应": return '<span class="status-badge status-pending">待响应</span>';
                case "已派单": return '<span class="status-badge status-dispatched">已派单</span>';
                case "已完成": return '<span class="status-badge status-completed">已完成</span>';
                default: return '<span class="status-badge bg-secondary">未知</span>';
            }
        }

        // 加载执法调度记录
        function loadLawDispatches(status = '', officerName = '', page = 1) {
            currentPage = page;
            document.getElementById('dispatchTableBody').innerHTML = '<tr><td colspan="9" class="text-center">加载中...</td></tr>';

            // 设置axios超时
            axios.defaults.timeout = 5000;

            axios.get(`${BASE_URL}/law-dispatches`, {
                params: {
                    status,
                    officer_name: officerName,
                    page: page,
                    pageSize: pageSize
                }
            })
            .then(res => {
                if (res.data.code === 200) {
                    const dispatches = res.data.data.records || res.data.data;
                    const total = res.data.data.total || dispatches.length;
                    document.getElementById('totalCount').textContent = total;

                    // 渲染表格
                    const tableBody = document.getElementById('dispatchTableBody');
                    if (dispatches.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">暂无数据</td></tr>';
                        renderPagination(total, page);
                        return;
                    }

                    tableBody.innerHTML = '';
                    dispatches.forEach(dispatch => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${dispatch.dispatch_id || ''}</td>
                            <td>${dispatch.officer_name || '未知'}</td>
                            <td>${dispatch.department || '未知'}</td>
                            <td>${dispatch.behavior_type || '未知'}</td>
                            <td>${dispatch.illegal_behavior_record_id || '未知'}</td>
                            <td>${formatTime(dispatch.dispatch_time)}</td>
                            <td>${formatTime(dispatch.complete_time) || '-'}</td>
                            <td>${getStatusBadge(dispatch.status || '未知')}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-primary update-status-btn"
                                            data-id="${dispatch.dispatch_id}"
                                            data-status="${dispatch.status}">更新状态</button>
                                    <button class="btn btn-danger delete-dispatch-btn"
                                            data-id="${dispatch.dispatch_id}">删除</button>
                                </div>
                            </td>
                        `;
                        tableBody.appendChild(tr);
                    });

                    // 绑定按钮事件
                    bindButtonEvents();
                    renderPagination(total, page);
                } else {
                    document.getElementById('dispatchTableBody').innerHTML = `<tr><td colspan="9" class="text-center text-danger">${res.data.msg}</td></tr>`;
                }
            })
            .catch(err => {
                console.error('加载执法调度记录失败：', err);
                document.getElementById('dispatchTableBody').innerHTML = '<tr><td colspan="9" class="text-center text-danger">加载失败，请刷新重试</td></tr>';
            });
        }

        // 加载执法人员列表（用于新增调度时选择）
        function loadLawEnforcers() {
            axios.get(`${BASE_URL}/law-enforcers`)
                .then(res => {
                    if (res.data.code === 200) {
                        const enforcers = res.data.data;
                        const select = document.getElementById('addOfficerId');
                        select.innerHTML = '<option value="">请选择执法人员</option>';

                        enforcers.forEach(enforcer => {
                            const option = document.createElement('option');
                            option.value = enforcer.office_id;
                            option.textContent = `${enforcer.name} (${enforcer.office_id}) - ${enforcer.department}`;
                            select.appendChild(option);
                        });
                    } else {
                        document.getElementById('addOfficerId').innerHTML = '<option value="">加载失败</option>';
                    }
                })
                .catch(err => {
                    console.error('执法人员加载失败：', err);
                    document.getElementById('addOfficerId').innerHTML = '<option value="">加载失败</option>';
                });
        }

        // 渲染分页控件
        function renderPagination(total, currentPage) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            const totalPages = Math.ceil(total / pageSize);

            if (totalPages <= 1) return;

            // 上一页
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="javascript:;" onclick="loadLawDispatches('${document.getElementById('statusFilter').value}', '${document.getElementById('officerNameFilter').value}', ${currentPage - 1})">上一页</a>`;
            pagination.appendChild(prevLi);

            // 页码
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="javascript:;" onclick="loadLawDispatches('${document.getElementById('statusFilter').value}', '${document.getElementById('officerNameFilter').value}', ${i})">${i}</a>`;
                pagination.appendChild(li);
            }

            // 下一页
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="javascript:;" onclick="loadLawDispatches('${document.getElementById('statusFilter').value}', '${document.getElementById('officerNameFilter').value}', ${currentPage + 1})">下一页</a>`;
            pagination.appendChild(nextLi);
        }

        // 绑定按钮事件
        function bindButtonEvents() {
            // 更新状态按钮
            document.querySelectorAll('.update-status-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const dispatchId = btn.getAttribute('data-id');
                    const currentStatus = btn.getAttribute('data-status');

                    document.getElementById('updateDispatchId').value = dispatchId || '';
                    document.getElementById('updateDispatchIdShow').value = dispatchId || '';
                    document.getElementById('currentStatus').value = currentStatus || '';
                    document.getElementById('newStatus').value = currentStatus || '待响应';

                    const modal = new bootstrap.Modal(document.getElementById('updateDispatchModal'));
                    modal.show();
                });
            });

            // 删除按钮
            document.querySelectorAll('.delete-dispatch-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const dispatchId = btn.getAttribute('data-id');
                    if (!dispatchId) {
                        alert('调度编号为空，无法删除');
                        return;
                    }
                    if (confirm('确定要删除该调度记录吗？')) {
                        axios.delete(`${BASE_URL}/law-dispatches/${dispatchId}`)
                            .then(res => {
                                if (res.data.code === 200) {
                                    alert('删除成功');
                                    const status = document.getElementById('statusFilter').value;
                                    const officerName = document.getElementById('officerNameFilter').value;
                                    loadLawDispatches(status, officerName, currentPage);
                                } else {
                                    alert('删除失败：' + (res.data.msg || '未知错误'));
                                }
                            })
                            .catch(err => {
                                alert('删除失败：' + (err.response?.data?.msg || '网络错误'));
                            });
                    }
                });
            });
        }

        // 保存新增调度
        document.getElementById('saveDispatchBtn').addEventListener('click', () => {
            const form = document.getElementById('addDispatchForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const dispatchId = document.getElementById('addDispatchId').value.trim();
            const illegalRecordId = document.getElementById('addIllegalRecordId').value.trim();
            const officerId = document.getElementById('addOfficerId').value;

            // 基础校验
            if (!dispatchId) {
                alert('调度编号不能为空');
                return;
            }
            if (!illegalRecordId) {
                alert('非法行为记录ID不能为空');
                return;
            }
            if (!officerId) {
                alert('请选择执法人员');
                return;
            }

            const data = {
                dispatch_id: dispatchId,
                illegal_behavior_record_id: illegalRecordId,
                officer_id: officerId
            };

            axios.post(`${BASE_URL}/law-dispatches`, data)
                .then(res => {
                    if (res.data.code === 200) {
                        alert('新增成功');
                        const modal = bootstrap.Modal.getInstance(document.getElementById('addDispatchModal'));
                        modal.hide();
                        loadLawDispatches('', '', 1); // 新增后刷新第一页
                        form.reset();
                    } else {
                        alert('新增失败：' + (res.data.msg || '未知错误'));
                    }
                })
                .catch(err => {
                    alert('新增失败：' + (err.response?.data?.msg || '网络错误，请检查后端服务'));
                });
        });

        // 提交状态更新
        document.getElementById('submitUpdateBtn').addEventListener('click', () => {
            const form = document.getElementById('updateDispatchForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const dispatchId = document.getElementById('updateDispatchId').value.trim();
            const newStatus = document.getElementById('newStatus').value;

            if (!dispatchId) {
                alert('调度编号为空，无法更新');
                return;
            }

            const data = {
                status: newStatus
            };

            axios.put(`${BASE_URL}/law-dispatches/${dispatchId}`, data)
                .then(res => {
                    if (res.data.code === 200) {
                        alert('状态更新成功');
                        const modal = bootstrap.Modal.getInstance(document.getElementById('updateDispatchModal'));
                        modal.hide();
                        const status = document.getElementById('statusFilter').value;
                        const officerName = document.getElementById('officerNameFilter').value;
                        loadLawDispatches(status, officerName, currentPage);
                    } else {
                        alert('更新失败：' + (res.data.msg || '未知错误'));
                    }
                })
                .catch(err => {
                    alert('更新失败：' + (err.response?.data?.msg || '网络错误'));
                });
        });

        // 搜索按钮事件
        document.getElementById('searchBtn').addEventListener('click', () => {
            const status = document.getElementById('statusFilter').value;
            const officerName = document.getElementById('officerNameFilter').value.trim();
            loadLawDispatches(status, officerName, 1); // 搜索后回到第一页
        });

        // 页面加载初始化
        window.onload = () => {
            // 初始化axios请求头
            axios.defaults.headers.post['Content-Type'] = 'application/json';
            axios.defaults.headers.put['Content-Type'] = 'application/json';

            loadLawDispatches('', '', 1);
            loadLawEnforcers();
        };
    </script>
</body>
</html>